<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Admin Panel</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">

  <style>
    body{
      font-family: Arial, Helvetica, sans-serif;
      background:#f6f6f6;
      margin:0;
      padding:0;
    }
    .wrap{
      max-width:1100px;
      margin:30px auto;
      padding:0 16px;
    }
    h1{ margin:0 0 10px; }
    .muted{ color:#555; font-size:13px; margin-bottom:16px; }

    .card{
      background:#fff;
      border:1px solid #ddd;
      border-radius:12px;
      padding:16px;
      margin-bottom:16px;
      box-shadow:0 6px 18px rgba(0,0,0,.06);
    }

    label{
      display:block;
      font-size:13px;
      margin-bottom:6px;
    }

    select, input{
      padding:8px 10px;
      font-size:14px;
      border-radius:8px;
      border:1px solid #ccc;
      width:100%;
      box-sizing:border-box;
    }

    button{
      padding:10px 14px;
      font-size:14px;
      border-radius:10px;
      border:1px solid #111;
      background:#111;
      color:#fff;
      cursor:pointer;
      margin-right:8px;
      margin-top:10px;
    }
    button.secondary{
      background:#fff;
      color:#111;
      border-color:#ccc;
    }

    .row{
      display:flex;
      gap:12px;
      flex-wrap:wrap;
      align-items:center;
    }

    .pill{
      display:inline-block;
      font-size:12px;
      padding:6px 10px;
      border:1px solid #ddd;
      border-radius:999px;
      background:#fafafa;
      margin-top:8px;
    }

    a{ color:#1a73e8; text-decoration:none; }
  </style>
</head>

<body>
<div class="wrap">

  <h1>Admin Panel</h1>
  <div class="muted">Export / Import shared data and download status logs.</div>

  <div class="card">
    <label for="machineSelect"><strong>Select machine (for logs)</strong></label>
    <select id="machineSelect">
      <option value="ALL">All machines</option>
    </select>
  </div>

  <div class="card">
    <h3>Export / Import</h3>
    <div class="row">
      <button id="exportBtn">Export ALL data</button>
      <input type="file" id="importFile" accept=".json">
      <button id="importBtn" class="secondary">Import data</button>
    </div>
    <div class="pill" id="exportStatus">Idle</div>
  </div>

  <div class="card">
    <h3>Status Change Logs</h3>
    <button id="downloadLogBtn">Download status log</button>
    <div class="pill" id="logStatus">Idle</div>
  </div>

  <div class="card">
    <a href="index.html">← Back to layout</a>
  </div>

</div>

<!-- Supabase CDN -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
/* ================================
   SUPABASE CONFIG — REQUIRED
   (must match index.html + machine.html)
================================ */
const SUPABASE_URL = "https://vycwkgpdivxazjgsrgiq.supabase.co";
const SUPABASE_ANON_KEY = "sb_publishable_aAjs8tF_8c8sB30ekxSXZQ_KxaBMBTE";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* ================================
   MACHINE IDS (same list as layout)
================================ */
const MACHINE_IDS = [
  "packout","2699","broach1","adcole","2958","2985","2984","2782","3068","3009",
  "blohm2","blohm1","3002","gardner","gardner-baby","3015","mapro","cts",
  "2712","2965","pump1","pump2"
];

const machineSelect = document.getElementById("machineSelect");
const exportStatus = document.getElementById("exportStatus");
const logStatus = document.getElementById("logStatus");

MACHINE_IDS.forEach(id=>{
  const o=document.createElement("option");
  o.value=id;
  o.textContent=id;
  machineSelect.appendChild(o);
});

/* ================================
   EXPORT ALL DATA
================================ */
document.getElementById("exportBtn").onclick = async ()=>{
  exportStatus.textContent = "Exporting…";

  const tables = [
    "machines",
    "project_entries",
    "production_entries",
    "status_log",
    "packout_goal"
  ];

  const out = {};
  for (const t of tables){
    const { data, error } = await supabase.from(t).select("*");
    if (error){
      alert("Export failed: " + error.message);
      exportStatus.textContent = "Error";
      return;
    }
    out[t] = data;
  }

  const blob = new Blob([JSON.stringify(out,null,2)], {type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "ZF82_export.json";
  a.click();

  exportStatus.textContent = "Export complete";
};

/* ================================
   IMPORT DATA
================================ */
document.getElementById("importBtn").onclick = async ()=>{
  const file = document.getElementById("importFile").files[0];
  if (!file) return alert("Select a JSON file first.");

  if (!confirm("This will INSERT rows into the database. Continue?")) return;

  exportStatus.textContent = "Importing…";

  const text = await file.text();
  const data = JSON.parse(text);

  for (const table of Object.keys(data)){
    if (!Array.isArray(data[table])) continue;
    if (!data[table].length) continue;

    const { error } = await supabase.from(table).insert(data[table]);
    if (error){
      alert("Import error in " + table + ": " + error.message);
      exportStatus.textContent = "Error";
      return;
    }
  }

  exportStatus.textContent = "Import complete";
};

/* ================================
   DOWNLOAD STATUS LOG
================================ */
document.getElementById("downloadLogBtn").onclick = async ()=>{
  logStatus.textContent = "Preparing log…";
  const sel = machineSelect.value;

  let q = supabase.from("status_log").select("*").order("changed_at",{ascending:true});
  if (sel !== "ALL") q = q.eq("machine_id", sel);

  const { data, error } = await q;
  if (error){
    alert("Log download failed: " + error.message);
    logStatus.textContent = "Error";
    return;
  }

  const lines = data.map(r =>
    `${r.changed_at} | ${r.machine_id} | ${r.from_status} -> ${r.to_status}`
  ).join("\n");

  const blob = new Blob([lines], {type:"text/plain"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = sel==="ALL" ? "status_log_all.txt" : `status_log_${sel}.txt`;
  a.click();

  logStatus.textContent = "Log downloaded";
};

/* ================================
   PASSWORD GATE (ZF135)
================================ */
(function(){
  const pw = prompt("Enter admin password:");
  if (pw !== "ZF135") {
    alert("Access denied");
    location.href = "index.html";
  }
})();
</script>
</body>
</html>
