<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Assembly Line Layout</title>

  <style>
    :root{
      --border: 2px solid #000;
      --thin: 1px solid #000;
      --bg: #ffffff;

      --green: #10a44a;
      --yellow:#ffd400;
      --red:   #e01616;
      --blue:  #1e63ff;
    }

    html, body { h:100%; }
    body{
      margin:0;
      font-family: Arial, Helvetica, sans-serif;
      background:#f6f6f6;
      display:flex;
      flex-direction:column;
      overflow:auto;
    }

    .wrap{
      w: min(1850px, 98vw);
      margin: 0 auto;
      padding: 12px 12px 0;
      box-sizing:border-box;
      display:flex;
      flex-direction:column;
      min-h:100vh;
    }

    .board{
      position:relative;
      w:100%;
      flex: 1 1 auto;
      aspect-ratio: 1828 / 661;
      background:var(--bg);
      border:var(--border);
      box-shadow:0 8px 24px rgba(0,0,0,.08);
      overflow:auto;
    }

    /* Scale + lift everything EXCEPT bottom row */
    .upper-layer{
      position:absolute;
      inset:0;
      transform-origin: top left;
      transform: translateY(-18px) scale(0.95);
    }

    .box{
      position:absolute;
      border:var(--thin);
      background:#fff;
      display:flex;
      align-items:center;
      justify-content:center;
      text-align:center;
      font-size:20px;
      padding:6px;
      box-sizing:border-box;
      text-decoration:none;
      color:#000;
      cursor:pointer;
      user-select:none;
      line-h:1.1;
      transition: transform .06s ease, box-shadow .12s ease, outline .12s ease;
    }
    .box:hover{ box-shadow:0 3px 10px rgba(0,0,0,.12); transform: translateY(-1px); }
    .box:active{ transform: translateY(0px); }

    .status-running{ background:#10a44a; }
    .status-problems{ background:#ffd400; }
    .status-down{ background:#e01616; }
    .status-no_operator{ background:#1e63ff; color:#fff; }

    .selected{ outline: 3px solid #1a73e8; outline-offset: 2px; }

    .vline{
      position:absolute;
      y:2%;
      bottom:2%;
      w:0;
      border-x: 4px solid #000;
    }

    .hline{
      position:absolute;
      h:0;
      border-y: 4px solid #000;
    }

    .packout span{
      writing-mode: vertical-rl;
      text-orientation: upright;
      letter-spacing: 1px;
      font-size:18px;
      user-select:none;
    }

    .panel{
      margin-y:10px;
      background:#fff;
      border:1px solid #ddd;
      border-radius:10px;
      padding:12px 14px;
      box-shadow:0 4px 14px rgba(0,0,0,.06);
    }

    .panel-row{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      justify-content:space-between;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border:1px solid #ddd;
      border-radius:999px;
      background:#fafafa;
      font-size:14px;
      white-space:nowrap;
    }

    select, button{
      font-size:14px;
      padding:8px 10px;
      border-radius:8px;
      border:1px solid #ccc;
      background:#fff;
      cursor:pointer;
    }

    button{ background:#111; color:#fff; border-color:#111; }
    button.secondary{ background:#fff; color:#111; border-color:#ccc; }

    /* Packout badge: half-ish width */
    .metric-badge{
      position:absolute;
      display:flex;
      flex-direction:column;
      justify-content:flex-start;
      border:1px solid #000;
      background:#fff;
      border-radius:10px;
      padding:8px 10px;
      font-size:12px;
      line-h:1.25;
      box-shadow:0 4px 12px rgba(0,0,0,.10);
      w: auto;
      box-sizing:border-box;
    }
    .metric-row{ display:flex; justify-content:space-between; gap:10px; }
    .metric-row span{ white-space:nowrap; }
    .small-muted{ color:#444; font-weight:normal; }
  </style>
</head>

<body>
<div class="wrap">

  <div class="board">

    <!-- UPPER LAYER (scaled) -->
    <div class="upper-layer">

      <!-- Packout box updated (width 9%, height 87%) -->
      <a class="box packout" data-id="packout" href="machine.html?id=packout"
         style="left:1%; top:4%; width:13.5%; height:30%;"><span>Packout</span></a>

      <!-- Packout badge updated (top 92%) -->
      <div id="packoutBadge" class="metric-badge" style="left:1.0%; top:36%; width:13.5%; height:60%;">
        <div style="font-weight:bold; margin-bottom:6px; text-align:center; font-size:14px;">PACKOUT</div>
        <div class="metric-row"><span>Weekly target</span></div>
        <div class="metric-row"><span>Actual</span></div>
        <div class="metric-row"><span id="packoutWeeklyDeltaLabel">Left</span></div>
        
        </div>
        <div class="metric-row"><span>YTD</span></div>
        <div class="metric-row">
</div>
        <div class="metric-row">
</div>
      </div>

      <div class="vline" style="left:15.5%;"></div>

      <a class="box" data-id="2699" href="machine.html?id=2699"
         style="left:19.5%; top:6.5%; width:7.5%; height:8.5%;">2699</a>

      <a class="box" data-id="broach1" href="machine.html?id=broach1"
         style="left:27.2%; top:6.5%; width:7.5%; height:8.5%;">Broach 1</a>

      <a class="box" data-id="adcole" href="machine.html?id=adcole"
         style="left:48.5%; top:6.5%; width:7.5%; height:8.5%;">Adcole</a>

      <a class="box" data-id="2958" href="machine.html?id=2958"
         style="left:78.0%; top:4.0%; width:8.8%; height:13.5%;">2958</a>

      <a class="box" data-id="2985" href="machine.html?id=2985"
         style="left:19.5%; top:21.0%; width:7.5%; height:9.0%;">2985</a>

      <a class="box" data-id="2984" href="machine.html?id=2984"
         style="left:27.2%; top:21.0%; width:7.5%; height:9.0%;">2984</a>

      <a class="box" data-id="2782" href="machine.html?id=2782"
         style="left:34.9%; top:21.0%; width:7.5%; height:9.0%;">2782</a>

      <a class="box" data-id="3068" href="machine.html?id=3068"
         style="left:69.0%; top:15.5%; width:7.5%; height:14.0%;">3068</a>

      <a class="box" data-id="3009" href="machine.html?id=3009"
         style="left:88.0%; top:18.5%; width:7.5%; height:14.0%;">3009</a>

      <a class="box" data-id="blohm2" href="machine.html?id=blohm2"
         style="left:19.5%; top:46.0%; width:7.5%; height:10.5%;">Blohm 2</a>

      <a class="box" data-id="blohm1" href="machine.html?id=blohm1"
         style="left:19.5%; top:59.0%; width:7.5%; height:10.5%;">Blohm 1</a>

      <a class="box" data-id="3002" href="machine.html?id=3002"
         style="left:30.2%; top:45.0%; width:7.5%; height:25.0%;">3002</a>

      <a class="box" data-id="gardner" href="machine.html?id=gardner"
         style="left:58.2%; top:44.0%; width:7.5%; height:25.0%;">Gardner</a>

      <a class="box" data-id="gardner-baby" href="machine.html?id=gardner-baby"
         style="left:69.8%; top:52.0%; width:7.5%; height:16.0%;">Gardner<br>(Baby)</a>

      <div class="hline" style="left:15.5%; right:48.5%; top:72.5%;"></div>
      <div class="hline" style="left:54.5%; right:6.0%;  top:72.5%;"></div>

      <a class="box" data-id="3015" href="machine.html?id=3015"
         style="left:19.5%; top:77.5%; width:7.5%; height:10.5%;">3015</a>

      <a class="box" data-id="mapro" href="machine.html?id=mapro"
         style="left:35.5%; top:77.5%; width:40.0%; height:10.5%;">Mapro</a>

      <a class="box" data-id="cts" href="machine.html?id=cts"
         style="left:76.0%; top:86.2%; width:16.0%; height:8.8%;">CTS</a>

    </div>

    <!-- BOTTOM ROW (not scaled) -->
    <a class="box" data-id="2712" href="machine.html?id=2712"
       style="left:16.0%; bottom:2.0%; width:7.5%; height:9.5%;">2712</a>

    <a class="box" data-id="2965" href="machine.html?id=2965"
       style="left:27.5%; bottom:2.0%; width:7.5%; height:9.5%;">2965</a>

    <a class="box" data-id="pump1" href="machine.html?id=pump1"
       style="left:42.0%; bottom:2.0%; width:24.0%; height:9.5%;">Pump 1</a>

    <a class="box" data-id="pump2" href="machine.html?id=pump2"
       style="left:74.5%; bottom:2.0%; width:24.0%; height:9.5%;">Pump 2</a>

  </div>

  <div class="panel">
    <div class="panel-row">

      <div class="pill"><strong>Selected:</strong> <span id="selectedLabel">None</span></div>

      <div class="pill">
        <strong>Status:</strong>
        <select id="statusSelect" disabled>
          <option value="running">Running</option>
          <option value="problems">Problems</option>
          <option value="down">Down</option>
          <option value="no_operator">No Operator</option>
        </select>
        <button id="applyBtn" disabled>Apply</button>
        <button class="secondary" id="clearBtn">Clear</button>
      </div>

      <div class="pill">
        <strong>Admin:</strong>
        <button class="secondary" id="adminBtn">Open</button>
      </div>

      <div class="pill">
        <strong>Layout Builder:</strong>
        <button class="secondary" id="layoutBtn">Open</button>
      </div>

      <div class="pill">
        <label style="display:flex; gap:8px; align-items:center;">
          <input type="checkbox" id="editMode" />
          <strong>Edit colors mode</strong>
        </label>
      </div>

      <div class="pill small-muted" id="cloudPill">Cloud: connecting…</div>

    </div>
  </div>

</div>

<!-- Supabase via CDN (works on static sites) -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  /***********************
   *  SUPABASE CONFIG
   ***********************/
  const SUPABASE_URL = "https://vycwkgpdivxazjgsrgiq.supabase.co";
  const SUPABASE_ANON_KEY = "sb_publishable_aAjs8tF_8c8sB30ekxSXZQ_KxaBMBTE";
  const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY); // docs pattern :contentReference[oaicite:2]{index=2}

  /***********************
   *  MACHINE IDS (from layout)
   ***********************/
  const MACHINE_IDS = [
    "packout","2699","broach1","adcole","2958","2985","2984","2782","3068","3009",
    "blohm2","blohm1","3002","gardner","gardner-baby","3015","mapro","cts",
    "2712","2965","pump1","pump2"
  ];

  const STATUS_CLASS = {
    running: 'status-running',
    problems: 'status-problems',
    down: 'status-down',
    no_operator: 'status-no_operator'
  };

  function applyStatus(el, s){
    Object.values(STATUS_CLASS).forEach(c=>el.classList.remove(c));
    el.classList.add(STATUS_CLASS[s] || STATUS_CLASS.running);
  }

  function iso(){
    const d=new Date();
    const yyyy=d.getFullYear();
    const mm=String(d.getMonth()+1).padStart(2,"0");
    const dd=String(d.getDate()).padStart(2,"0");
    return `${yyyy}-${mm}-${dd}`;
  }

  function startOfYearISO(){
    const y = new Date().getFullYear();
    return `${y}-01-01`;
  }
  function startOfMonthISO(){
    const d=new Date();
    const y=d.getFullYear();
    const m=String(d.getMonth()+1).padStart(2,"0");
    return `${y}-${m}-01`;
  }

  function safeNum(x){
    const n = Number(String(x ?? "").trim());
    return Number.isFinite(n) ? n : 0;
  }
  function fmtVs(actual, goal){
    if (!goal || goal <= 0) return `${actual.toLocaleString()}`;
    const pct = (actual / goal) * 100;
    return `${actual.toLocaleString()} (${pct.toFixed(1)}%)`;
  }

  /***********************
   *  SUPABASE: Ensure machine rows exist (insert missing only)
   ***********************/
  async function ensureMachinesExist(){
    const { data, error } = await sb
      .from("machines")
      .select("id")
      .in("id", MACHINE_IDS);

    if (error) throw error;

    const existing = new Set((data || []).map(r => r.id));
    const missing = MACHINE_IDS.filter(id => !existing.has(id));

    if (missing.length){
      const rows = missing.map(id => ({ id, status: "running", status_since: new Date().toISOString() }));
      const ins = await sb.from("machines").insert(rows);
      if (ins.error) throw ins.error;
    }
  }

  async function fetchMachines(){
    const { data, error } = await sb
      .from("machines")
      .select("id,status,status_since")
      .in("id", MACHINE_IDS);

    if (error) throw error;
    const map = new Map();
    (data || []).forEach(r => map.set(r.id, r));
    return map;
  }

  async function updateMachineStatus(id, toStatus){
    // read current to log from_status
    const { data: cur, error: curErr } = await sb
      .from("machines")
      .select("status")
      .eq("id", id)
      .maybeSingle();
    if (curErr) throw curErr;
    const fromStatus = (cur?.status || "running").toLowerCase();

    const nowIso = new Date().toISOString();

    const up = await sb
      .from("machines")
      .update({ status: toStatus, status_since: nowIso })
      .eq("id", id);
    if (up.error) throw up.error;

    // status log
    const log = await sb
      .from("status_log")
      .insert([{ machine_id: id, changed_at: nowIso, from_status: fromStatus, to_status: toStatus }]);
    if (log.error) throw log.error;
  }

  /***********************
 *  PACKOUT BADGE (weekly target + actual)
 ***********************/
function getWeekStartMonday(d = new Date()){
  const dt = new Date(d);
  const day = dt.getDay(); // 0 Sun .. 6 Sat
  const diff = (day === 0 ? -6 : 1) - day; // move to Monday
  dt.setDate(dt.getDate() + diff);
  dt.setHours(0,0,0,0);
  return dt;
}
function addDays(dateObj, days){ const d = new Date(dateObj); d.setDate(d.getDate()+days); return d; }
function fmtISODate(d){
  const y=d.getFullYear();
  const m=String(d.getMonth()+1).padStart(2,"0");
  const da=String(d.getDate()).padStart(2,"0");
  return `${y}-${m}-${da}`;
}

async function fetchWeeklyTarget(weekStartISO){
  const { data, error } = await sb
    .from("goals_weekly")
    .select("weekly_target")
    .eq("machine_id","packout")
    .eq("week_start", weekStartISO)
    .maybeSingle();
  if (error) throw error;
  return safeNum(data?.weekly_target);
}

async function fetchWeeklyActual(weekStartISO, weekEndISO){
  const { data, error } = await sb
    .from("production_entries")
    .select("parts_ran,prod_date")
    .eq("machine_id","packout")
    .gte("prod_date", weekStartISO)
    .lt("prod_date", weekEndISO);
  if (error) throw error;
  return (data || []).reduce((sum,r)=>sum + safeNum(r.parts_ran), 0);
}

async function renderPackoutBadge(){
  const tEl = document.getElementById("packoutWeeklyTarget");
  const aEl = document.getElementById("packoutWeeklyActual");
  const labEl = document.getElementById("packoutWeeklyDeltaLabel");
  const dEl = document.getElementById("packoutWeeklyDelta");

  try{
    const weekStart = getWeekStartMonday(new Date());
    const weekEnd = addDays(weekStart, 7);
    const weekStartISO = fmtISODate(weekStart);
    const weekEndISO = fmtISODate(weekEnd);

    const [target, actual] = await Promise.all([
      fetchWeeklyTarget(weekStartISO).catch(()=>0),
      fetchWeeklyActual(weekStartISO, weekEndISO).catch(()=>0)
    ]);

    if (tEl) tEl.textContent = Number(target || 0).toLocaleString();
    if (aEl) aEl.textContent = Number(actual || 0).toLocaleString();

    if (Number(actual || 0) <= Number(target || 0)){
      const left = Number(target || 0) - Number(actual || 0);
      if (labEl) labEl.textContent = "Left";
      if (dEl) dEl.textContent = left.toLocaleString();
    } else {
      const ahead = Number(actual || 0) - Number(target || 0);
      if (labEl) labEl.textContent = "Ahead";
      if (dEl) dEl.textContent = ahead.toLocaleString();
    }
  } catch(e){
    console.error("Packout badge error:", e);
    if (tEl) tEl.textContent = "0";
    if (aEl) aEl.textContent = "0";
    if (labEl) labEl.textContent = "Left";
    if (dEl) dEl.textContent = "0";
  }
}

  /***********************
   *  UI: selection/edit mode
   ***********************/
  const editMode=document.getElementById("editMode");
  const statusSelect=document.getElementById("statusSelect");
  const applyBtn=document.getElementById("applyBtn");
  const clearBtn=document.getElementById("clearBtn");
  const selectedLabel=document.getElementById("selectedLabel");
  const cloudPill=document.getElementById("cloudPill");

  let selected=null;

  editMode.checked = localStorage.getItem("editMode") !== "false";
  editMode.onchange = () => {
    localStorage.setItem("editMode", editMode.checked);
    if(!editMode.checked) select(null);
  };

  function select(el){
    document.querySelectorAll(".selected").forEach(e=>e.classList.remove("selected"));
    selected=el;
    if(!el){
      selectedLabel.textContent="None";
      statusSelect.disabled=true;
      applyBtn.disabled=true;
      return;
    }
    el.classList.add("selected");
    selectedLabel.textContent=el.dataset.id;
    statusSelect.disabled=false;
    applyBtn.disabled=false;
  }

  clearBtn.onclick = ()=> select(null);

  applyBtn.onclick = async ()=>{
    if(!selected) return;
    const id = selected.dataset.id;
    const toStatus = statusSelect.value;

    applyBtn.disabled = true;
    cloudPill.textContent = "Cloud: saving…";

    try{
      await updateMachineStatus(id, toStatus);
      // repaint immediately
      applyStatus(selected, toStatus);
      cloudPill.textContent = "Cloud: saved ✓";
    }catch(err){
      console.error(err);
      cloudPill.textContent = "Cloud: error saving";
      alert("Error saving to cloud. Check console.");
    }finally{
      applyBtn.disabled = false;
    }
  };

  // Admin password (unchanged)
  document.getElementById("adminBtn").onclick=()=>{
    const pw=prompt("Enter admin password:");
    if(pw==="ZF135") location.href="admin.html";
    else if(pw!==null) alert("Incorrect password");
  };

  
// Layout Builder (password-gated; client-side)
document.getElementById("layoutBtn").onclick=()=>{
  const pw=prompt("Layout Builder password:");
  if(pw==="layout82"){
    sessionStorage.setItem("layoutBuilderAuthed","1");
    location.href="layout.html";
  } else if(pw!==null){
    alert("Incorrect password");
  }
};

// Apply saved layout (if present) from Supabase
async function applySavedLayout(){
  try{
    const { data, error } = await sb
      .from("layout_elements")
      .select("element_id,x,y,bottom,w,h");
    if (error) throw error;
    if (!data || !data.length) return;

    for (const row of data){
      const elId = row.element_id;
      let el = document.querySelector(`[data-id="${elId}"]`);
      if (!el && elId === "packoutBadge"){
        el = document.getElementById("packoutBadge");
      }
      if (!el) continue;

      if (row.x != null) el.style.left = `${row.x}%`;
      if (row.y != null) el.style.top = `${row.y}%`;
      if (row.bottom != null) el.style.bottom = `${row.bottom}%`;
      if (row.w != null) el.style.width = `${row.w}%`;
      if (row.h != null) el.style.height = `${row.h}%`;
    }
  }catch(e){
    console.warn("Layout load failed (table may not exist yet):", e);
  }
}

function wireBoxClicks(){
    document.querySelectorAll('.box[data-id]').forEach(b=>{
      b.onclick = (e)=>{
        if(editMode.checked){
          e.preventDefault();
          select(b);
        }
      };
    });
  }

  async function loadBoard(){
    cloudPill.textContent = "Cloud: connecting…";
    await ensureMachinesExist();
    const map = await fetchMachines();

    document.querySelectorAll('.box[data-id]').forEach(b=>{
      const row = map.get(b.dataset.id);
      const status = (row?.status || "running").toLowerCase();
      applyStatus(b, status);
    });

    cloudPill.textContent = "Cloud: connected ✓";
  }

  async function refreshSelectedStatus(){
    if(!selected) return;
    const id = selected.dataset.id;
    const { data, error } = await sb.from("machines").select("status").eq("id", id).maybeSingle();
    if(!error){
      statusSelect.value = (data?.status || "running").toLowerCase();
    }
  }

  // Basic polling so other PCs’ changes show up (every 5 seconds)
  async function poll(){
    try{
      const map = await fetchMachines();
      document.querySelectorAll('.box[data-id]').forEach(b=>{
        const row = map.get(b.dataset.id);
        const status = (row?.status || "running").toLowerCase();
        applyStatus(b, status);
      });
      await renderPackoutBadge();
      await refreshSelectedStatus();
    }catch(err){
      console.error(err);
      cloudPill.textContent = "Cloud: polling error";
    }
  }

  (async function init(){
    try{
      wireBoxClicks();
            await applySavedLayout();
await loadBoard();
      await renderPackoutBadge();
      // initial select state
      statusSelect.disabled = true;
      applyBtn.disabled = true;

      // poll updates
      setInterval(poll, 5000);
    }catch(err){
      console.error(err);
      cloudPill.textContent = "Cloud: connection error";
      alert("Cloud connection error. Check console + Supabase keys/RLS.");
    }
  })();
</script>
</body>
</html>

