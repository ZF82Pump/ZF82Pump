<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Assembly Line Layout</title>

  <style>
    :root{
      --border: 2px solid #000;
      --thin: 1px solid #000;
      --bg: #ffffff;

      --green: #10a44a;
      --yellow:#ffd400;
      --red:   #e01616;
      --blue:  #1e63ff;
    }

    html, body { h:100%; }
    body{
      margin:0;
      font-family: Arial, Helvetica, sans-serif;
      background:#f6f6f6;
      display:flex;
      flex-direction:column;
      overflow:auto;
    }

    .wrap{
      width: min(1850px, 98vw);
      margin: 0 auto;
      padding: 12px 12px 0;
      box-sizing:border-box;
      display:flex;
      flex-direction:column;
      min-height:100vh;
    }

    .board{
      position:relative;
      width:100%;
      flex: 1 1 auto;
      aspect-ratio: 1828 / 661;
      background:var(--bg);
      border:var(--border);
      box-shadow:0 8px 24px rgba(0,0,0,.08);
      overflow:auto;
    }

    /* Scale + lift everything EXCEPT bottom row */
    .upper-layer{
      position:absolute;
      inset:0;
      transform-origin: top left;
      transform: translateY(-18px) scale(0.95);
    }

    .box{
      position:absolute;
      border:var(--thin);
      background:#fff;
      display:flex;
      align-items:center;
      justify-content:center;
      text-align:center;
      font-size:20px;
      padding:6px;
      box-sizing:border-box;
      text-decoration:none;
      color:#000;
      cursor:pointer;
      user-select:none;
      line-h:1.1;
      transition: transform .06s ease, box-shadow .12s ease, outline .12s ease;
    }
    .box:hover{ box-shadow:0 3px 10px rgba(0,0,0,.12); transform: translateY(-1px); }
    .box:active{ transform: translateY(0px); }

    .status-running{ background:#10a44a; }
    .status-problems{ background:#ffd400; }
    .status-down{ background:#e01616; }
    .status-no_operator{ background:#1e63ff; color:#fff; }

    .selected{ outline: 3px solid #1a73e8; outline-offset: 2px; }

    .vline{
      position:absolute;
      y:2%;
      bottom:2%;
      width:0;
      border-x: 4px solid #000;
    }

    .hline{
      position:absolute;
      height:0;
      border-y: 4px solid #000;
    }

    .packout span{
      writing-mode: horizontal-tb;
      text-orientation: mixed;
      letter-spacing: 0px;
      font-size:16px;
      user-select:none;
    }

    .panel{
      margin-y:10px;
      background:#fff;
      border:1px solid #ddd;
      border-radius:10px;
      padding:12px 14px;
      box-shadow:0 4px 14px rgba(0,0,0,.06);
    }

    .panel-row{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      justify-content:space-between;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border:1px solid #ddd;
      border-radius:999px;
      background:#fafafa;
      font-size:14px;
      white-space:nowrap;
    }

    select, button{
      font-size:14px;
      padding:8px 10px;
      border-radius:8px;
      border:1px solid #ccc;
      background:#fff;
      cursor:pointer;
    }

    button{ background:#111; color:#fff; border-color:#111; }
    button.secondary{ background:#fff; color:#111; border-color:#ccc; }

    /* Packout badge: half-ish width */
    .metric-badge{
      position:absolute;
      display:flex;
      flex-direction:column;
      justify-content:flex-start;
      border:1px solid #000;
      background:#fff;
      border-radius:10px;
      padding:8px 10px;
      font-size:12px;
      line-h:1.25;
      box-shadow:0 4px 12px rgba(0,0,0,.10);
      width: auto;
      box-sizing:border-box;
    }
    .metric-row{ display:flex; justify-content:space-between; gap:10px; }
    .metric-row span{ white-space:nowrap; }
    .small-muted{ color:#444; font-weight:normal; }


.badge-ok { background:#dcfce7; }
.badge-warn { background:#fef9c3; }
.badge-bad { background:#fee2e2; }
.badge-na { background:#eee; }
  </style>
</head>

<body>
<div class="wrap">

  <div class="board">

    <!-- UPPER LAYER (scaled) -->
    <div class="upper-layer">

      <!-- Packout box updated (width 9%, height 87%) -->
      <a class="box packout" data-id="packout" href="machine.html?id=packout"
         style="left:1%; top:4%; width:13.5%; height:30%;"><span>Packout</span></a>

      <!-- Packout badge updated (top 92%) -->
      
<div id="packoutBadge" class="metric-badge" style="left:1.0%; top:36%; width:13.5%; height:60%;">
  <div style="font-weight:bold; margin-bottom:6px; text-align:center; font-size:14px;">PACKOUT</div>

  <div class="metric-row"><span>Weekly goal</span><span id="poWGoal">—</span></div>
  <div class="metric-row"><span>Weekly actual</span><span id="poWAct">—</span></div>
  <div class="metric-row"><span id="poWDeltaLabel">Left</span><span id="poWDelta">—</span></div>

  <div style="height:8px;"></div>

  <div class="metric-row"><span>Monthly goal</span><span id="poMGoal">—</span></div>
  <div class="metric-row"><span>Monthly actual</span><span id="poMAct">—</span></div>
  <div class="metric-row"><span id="poMDeltaLabel">Left</span><span id="poMDelta">—</span></div>

  <div style="height:8px;"></div>

  <div class="metric-row"><span>Yearly goal</span><span id="poYGoal">—</span></div>
  <div class="metric-row"><span>Yearly actual</span><span id="poYAct">—</span></div>
  <div class="metric-row"><span id="poYDeltaLabel">Left</span><span id="poYDelta">—</span></div>

  <div style="height:8px;"></div>
  <div class="metric-row"><span>Year %</span><span id="poYPct">—</span></div>
  <div style="height:10px;"></div>
  <div style="font-weight:700; font-size:12px; margin-bottom:6px;">Legend</div>
  <div style="display:grid; grid-template-columns: 1fr 1fr; gap:6px; font-size:11px;">
    <div style="display:flex; align-items:center; gap:6px;">
      <span style="width:10px; height:10px; border-radius:3px; background:#22c55e; display:inline-block;"></span>
      <span>Running</span>
    </div>
    <div style="display:flex; align-items:center; gap:6px;">
      <span style="width:10px; height:10px; border-radius:3px; background:#eab308; display:inline-block;"></span>
      <span>Problems</span>
    </div>
    <div style="display:flex; align-items:center; gap:6px;">
      <span style="width:10px; height:10px; border-radius:3px; background:#ef4444; display:inline-block;"></span>
      <span>Down</span>
    </div>
    <div style="display:flex; align-items:center; gap:6px;">
      <span style="width:10px; height:10px; border-radius:3px; background:#3b82f6; display:inline-block;"></span>
      <span>No Operator</span>
    </div>
  </div>

</div>

<div class="vline" style="left:15.5%;"></div>

      <div class="vline" style="left:15.5%;"></div>


      <a class="box" data-id="2699" href="machine.html?id=2699"
         style="left:19.5%; top:6.5%; width:7.5%; height:8.5%;">2699</a>

      <a class="box" data-id="broach1" href="machine.html?id=broach1"
         style="left:27.2%; top:6.5%; width:7.5%; height:8.5%;">Broach 1</a>

      <a class="box" data-id="adcole" href="machine.html?id=adcole"
         style="left:48.5%; top:6.5%; width:7.5%; height:8.5%;">Adcole</a>

      <a class="box" data-id="2958" href="machine.html?id=2958"
         style="left:78.0%; top:4.0%; width:8.8%; height:13.5%;">2958</a>

      <a class="box" data-id="2985" href="machine.html?id=2985"
         style="left:19.5%; top:21.0%; width:7.5%; height:9.0%;">2985</a>

      <a class="box" data-id="2984" href="machine.html?id=2984"
         style="left:27.2%; top:21.0%; width:7.5%; height:9.0%;">2984</a>

      <a class="box" data-id="2782" href="machine.html?id=2782"
         style="left:34.9%; top:21.0%; width:7.5%; height:9.0%;">2782</a>

      <a class="box" data-id="3068" href="machine.html?id=3068"
         style="left:69.0%; top:15.5%; width:7.5%; height:14.0%;">3068</a>

      <a class="box" data-id="3009" href="machine.html?id=3009"
         style="left:88.0%; top:18.5%; width:7.5%; height:14.0%;">3009</a>

      <a class="box" data-id="blohm2" href="machine.html?id=blohm2"
         style="left:19.5%; top:46.0%; width:7.5%; height:10.5%;">Blohm 2</a>

      <a class="box" data-id="blohm1" href="machine.html?id=blohm1"
         style="left:19.5%; top:59.0%; width:7.5%; height:10.5%;">Blohm 1</a>

      <a class="box" data-id="3002" href="machine.html?id=3002"
         style="left:30.2%; top:45.0%; width:7.5%; height:25.0%;">3002</a>

      <a class="box" data-id="gardner" href="machine.html?id=gardner"
         style="left:58.2%; top:44.0%; width:7.5%; height:25.0%;">Gardner</a>

      <a class="box" data-id="gardner-baby" href="machine.html?id=gardner-baby"
         style="left:69.8%; top:52.0%; width:7.5%; height:16.0%;">Gardner<br>(Baby)</a>

      <div class="hline" style="left:15.5%; right:48.5%; top:72.5%;"></div>
      <div class="hline" style="left:54.5%; right:6.0%;  top:72.5%;"></div>

      <a class="box" data-id="3015" href="machine.html?id=3015"
         style="left:19.5%; top:77.5%; width:7.5%; height:10.5%;">3015</a>

      <a class="box" data-id="mapro" href="machine.html?id=mapro"
         style="left:35.5%; top:77.5%; width:40.0%; height:10.5%;">Mapro</a>

      <a class="box" data-id="cts" href="machine.html?id=cts"
         style="left:76.0%; top:86.2%; width:16.0%; height:8.8%;">CTS</a>

    </div>

    <!-- BOTTOM ROW (not scaled) -->
    <a class="box" data-id="2712" href="machine.html?id=2712"
       style="left:16.0%; bottom:2.0%; width:7.5%; height:9.5%;">2712</a>

    <a class="box" data-id="2965" href="machine.html?id=2965"
       style="left:27.5%; bottom:2.0%; width:7.5%; height:9.5%;">2965</a>

    <a class="box" data-id="pump1" href="machine.html?id=pump1"
       style="left:42.0%; bottom:2.0%; width:24.0%; height:9.5%;">Pump 1</a>

    <a class="box" data-id="pump2" href="machine.html?id=pump2"
       style="left:74.5%; bottom:2.0%; width:24.0%; height:9.5%;">Pump 2</a>


    <!-- Pump weekly output badges (auto from production_entries, current week) -->
    <div id="pump1WeeklyBadge" class="metric-badge" style="left:61.5%; bottom:12.0%; width:6.0%; height:7.0%; padding:6px 8px;">
      <div style="font-weight:800; font-size:11px; text-align:center;">WTD</div>
      <div style="font-weight:800; font-size:14px; text-align:center;" id="pump1WTD">—</div>
    </div>

    <div id="pump2WeeklyBadge" class="metric-badge" style="left:93.5%; bottom:12.0%; width:6.0%; height:7.0%; padding:6px 8px;">
      <div style="font-weight:800; font-size:11px; text-align:center;">WTD</div>
      <div style="font-weight:800; font-size:14px; text-align:center;" id="pump2WTD">—</div>
    </div>

  </div>

  <div class="panel">
    <div class="panel-row">

      <div class="pill"><strong>Selected:</strong> <span id="selectedLabel">None</span></div>

      <div class="pill">
        <strong>Status:</strong>
        <select id="statusSelect" disabled>
          <option value="running">Running</option>
          <option value="problems">Problems</option>
          <option value="down">Down</option>
          <option value="no_operator">No Operator</option>
        </select>
        <button id="applyBtn" disabled>Apply</button>
        <button class="secondary" id="clearBtn">Clear</button>
      </div>

      <div class="pill">
        <strong>Admin:</strong>
        <button class="secondary" id="adminBtn">Open</button>
      </div>

      <div class="pill">
        <strong>Layout Builder:</strong>
        <button class="secondary" id="layoutBtn">Open</button>
      </div>

      <div class="pill">
        <label style="display:flex; gap:8px; align-items:center;">
          <input type="checkbox" id="editMode" />
          <strong>Edit colors mode</strong>
        </label>
      </div>

      <div class="pill small-muted" id="cloudPill">Cloud: connecting…</div>

    </div>
  </div>

</div>

<!-- Supabase via CDN (works on static sites) -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  /***********************
   *  SUPABASE CONFIG
   ***********************/
  const SUPABASE_URL = "https://vycwkgpdivxazjgsrgiq.supabase.co";
  const SUPABASE_ANON_KEY = "sb_publishable_aAjs8tF_8c8sB30ekxSXZQ_KxaBMBTE";
  // docs pattern :contentReference[oaicite:2]{index=2}

  /***********************
   *  MACHINE IDS (from layout)
   ***********************/
  const MACHINE_IDS = [
    "packout","2699","broach1","adcole","2958","2985","2984","2782","3068","3009",
    "blohm2","blohm1","3002","gardner","gardner-baby","3015","mapro","cts",
    "2712","2965","pump1","pump2"
  ];

  const STATUS_CLASS = {
    running: 'status-running',
    problems: 'status-problems',
    down: 'status-down',
    no_operator: 'status-no_operator'
  };

  function applyStatus(el, s){
    Object.values(STATUS_CLASS).forEach(c=>el.classList.remove(c));
    el.classList.add(STATUS_CLASS[s] || STATUS_CLASS.running);
  }

  function iso(){
    const d=new Date();
    const yyyy=d.getFullYear();
    const mm=String(d.getMonth()+1).padStart(2,"0");
    const dd=String(d.getDate()).padStart(2,"0");
    return `${yyyy}-${mm}-${dd}`;
  }

  function startOfYearISO(){
    const y = new Date().getFullYear();
    return `${y}-01-01`;
  }
  function startOfMonthISO(){
    const d=new Date();
    const y=d.getFullYear();
    const m=String(d.getMonth()+1).padStart(2,"0");
    return `${y}-${m}-01`;
  }

  function safeNum(x){
    const n = Number(String(x ?? "").trim());
    return Number.isFinite(n) ? n : 0;
  }
  function fmtVs(actual, goal){
    if (!goal || goal <= 0) return `${actual.toLocaleString()}`;
    const pct = (actual / goal) * 100;
    return `${actual.toLocaleString()} (${pct.toFixed(1)}%)`;
  }

  /***********************
   *  SUPABASE: Ensure machine rows exist (insert missing only)
   ***********************/
  async function ensureMachinesExist(){
    const { data, error } = await sb
      .from("machines")
      .select("id")
      .in("id", MACHINE_IDS);

    if (error) throw error;

    const existing = new Set((data || []).map(r => r.id));
    const missing = MACHINE_IDS.filter(id => !existing.has(id));

    if (missing.length){
      const rows = missing.map(id => ({ id, status: "running", status_since: new Date().toISOString() }));
      const ins = await sb.from("machines").insert(rows);
      if (ins.error) throw ins.error;
    }
  }

  async function fetchMachines(){
    const { data, error } = await sb
      .from("machines")
      .select("id,status,status_since")
      .in("id", MACHINE_IDS);

    if (error) throw error;
    const map = new Map();
    (data || []).forEach(r => map.set(r.id, r));
    return map;
  }

  async function updateMachineStatus(id, toStatus){
    // read current to log from_status
    const { data: cur, error: curErr } = await sb
      .from("machines")
      .select("status")
      .eq("id", id)
      .maybeSingle();
    if (curErr) throw curErr;
    const fromStatus = (cur?.status || "running").toLowerCase();

    const nowIso = new Date().toISOString();

    const up = await sb
      .from("machines")
      .update({ status: toStatus, status_since: nowIso })
      .eq("id", id);
    if (up.error) throw up.error;

    // status log
    const log = await sb
      .from("status_log")
      .insert([{ machine_id: id, changed_at: nowIso, from_status: fromStatus, to_status: toStatus }]);
    if (log.error) throw log.error;
  }

  /***********************
 *  PACKOUT BADGE (weekly target + actual)
 ***********************/
function getWeekStartMonday(d = new Date()){
  const dt = new Date(d);
  const day = dt.getDay(); // 0 Sun .. 6 Sat
  const diff = (day === 0 ? -6 : 1) - day; // move to Monday
  dt.setDate(dt.getDate() + diff);
  dt.setHours(0,0,0,0);
  return dt;
}
function addDays(dateObj, days){ const d = new Date(dateObj); d.setDate(d.getDate()+days); return d; }
function fmtISODate(d){
  const y=d.getFullYear();
  const m=String(d.getMonth()+1).padStart(2,"0");
  const da=String(d.getDate()).padStart(2,"0");
  return `${y}-${m}-${da}`;
}

async function fetchWeeklyGoalsUpToCurrentWeek(){
  const now = new Date();
  const year = now.getFullYear();
  const yearStartISO = `${year}-01-01`;
  const currentWeekStart = getWeekStartMonday(now);
  const currentWeekISO = fmtISODate(currentWeekStart);

  const { data, error } = await sb
    .from("weekly_goals")
    .select("week_start,goal")
    .eq("machine_id","packout")
    .gte("week_start", yearStartISO)
    .lte("week_start", currentWeekISO);

  if (error) throw error;
  return { rows: (data || []), currentWeekISO, now };
}

async function fetchActualRange(fromISO, toISOExclusive){
  const { data, error } = await sb
    .from("production_entries")
    .select("parts_ran,prod_date")
    .eq("machine_id","packout")
    .gte("prod_date", fromISO)
    .lt("prod_date", toISOExclusive);
  if (error) throw error;
  return (data || []).reduce((sum,r)=>sum + safeNum(r.parts_ran), 0);
}


function setActualColor(el, goal, actual){
  if(!el) return;
  el.classList.remove("badge-ok","badge-warn","badge-bad","badge-na");
  const g = Number(goal||0);
  const a = Number(actual||0);
  if(g <= 0){ el.classList.add("badge-na"); return; }
  if(a >= g) el.classList.add("badge-ok");
  else if(a >= 0.9 * g) el.classList.add("badge-warn");
  else el.classList.add("badge-bad");
}

function leftOrOver(goal, actual){
  const diff = Number(goal||0) - Number(actual||0);
  if (diff >= 0) return { label: "Left", value: diff };
  return { label: "Over", value: Math.abs(diff) };
}

async function renderPackoutBadge(){
  const els = {
    wGoal: document.getElementById("poWGoal"),
    wAct: document.getElementById("poWAct"),
    wDLab: document.getElementById("poWDeltaLabel"),
    wD: document.getElementById("poWDelta"),

    mGoal: document.getElementById("poMGoal"),
    mAct: document.getElementById("poMAct"),
    mDLab: document.getElementById("poMDeltaLabel"),
    mD: document.getElementById("poMDelta"),

    yGoal: document.getElementById("poYGoal"),
    yAct: document.getElementById("poYAct"),
    yDLab: document.getElementById("poYDeltaLabel"),
    yD: document.getElementById("poYDelta"),

    yPct: document.getElementById("poYPct"),
  };

  try{
    const now = new Date();
    const weekStart = getWeekStartMonday(now);
    const weekEnd = addDays(weekStart, 7);
    const weekStartISO = fmtISODate(weekStart);
    const weekEndISO = fmtISODate(weekEnd);

    // Goals (weekly calendar)
    const { rows } = await fetchWeeklyGoalsUpToCurrentWeek();
    const goalMap = new Map(rows.map(r=>[r.week_start, safeNum(r.goal)]));

    const weeklyGoal = safeNum(goalMap.get(weekStartISO));

    // Monthly goal: sum weeks in this month up to current week
    let monthlyGoal = 0;
    for (const [wsISO, g] of goalMap.entries()){
      const d = new Date(wsISO + "T00:00:00");
      if (d.getMonth() !== now.getMonth()) continue;
      monthlyGoal += safeNum(g);
    }

    // Yearly goal: sum all weeks up to current week (rows already filtered)
    let yearlyGoal = 0;
    for (const g of goalMap.values()) yearlyGoal += safeNum(g);

    // Actuals
    const weeklyActual = await fetchActualRange(weekStartISO, weekEndISO);

    const monthStartISO = fmtISODate(new Date(now.getFullYear(), now.getMonth(), 1));
    const nextMonthISO = fmtISODate(new Date(now.getFullYear(), now.getMonth()+1, 1));
    const monthlyActual = await fetchActualRange(monthStartISO, nextMonthISO);

    const yearStartISO = fmtISODate(new Date(now.getFullYear(), 0, 1));
    const nextYearISO = fmtISODate(new Date(now.getFullYear()+1, 0, 1));
    const yearlyActual = await fetchActualRange(yearStartISO, nextYearISO);

    const w = leftOrOver(weeklyGoal, weeklyActual);
    const m = leftOrOver(monthlyGoal, monthlyActual);
    const y = leftOrOver(yearlyGoal, yearlyActual);
    const pct = yearlyGoal > 0 ? Math.round((yearlyActual / yearlyGoal) * 1000)/10 : 0;

    if (els.wGoal) els.wGoal.textContent = weeklyGoal.toLocaleString();
    if (els.wAct) els.wAct.textContent = weeklyActual.toLocaleString();
    setActualColor(els.wAct, weeklyGoal, weeklyActual);
    if (els.wDLab) els.wDLab.textContent = w.label;
    if (els.wD) els.wD.textContent = w.value.toLocaleString();

    if (els.mGoal) els.mGoal.textContent = monthlyGoal.toLocaleString();
    if (els.mAct) els.mAct.textContent = monthlyActual.toLocaleString();
    setActualColor(els.mAct, monthlyGoal, monthlyActual);
    if (els.mDLab) els.mDLab.textContent = m.label;
    if (els.mD) els.mD.textContent = m.value.toLocaleString();

    if (els.yGoal) els.yGoal.textContent = yearlyGoal.toLocaleString();
    if (els.yAct) els.yAct.textContent = yearlyActual.toLocaleString();
    setActualColor(els.yAct, yearlyGoal, yearlyActual);
    if (els.yDLab) els.yDLab.textContent = y.label;
    if (els.yD) els.yD.textContent = y.value.toLocaleString();

    if (els.yPct) els.yPct.textContent = pct.toLocaleString() + "%";
  }catch(e){
    console.warn("Packout badge error:", e);
    // fail-safe defaults
    for (const k of Object.keys(els)){
      if (!els[k]) continue;
      if (k.endsWith("Lab")) els[k].textContent = "Left";
      else els[k].textContent = "0";
    }
  }
}

  /***********************
   *  UI: selection/edit mode
   ***********************/
  const editMode=document.getElementById("editMode");
  const statusSelect=document.getElementById("statusSelect");
  const applyBtn=document.getElementById("applyBtn");
  const clearBtn=document.getElementById("clearBtn");
  const selectedLabel=document.getElementById("selectedLabel");
  const cloudPill=document.getElementById("cloudPill");

  let selected=null;

  editMode.checked = localStorage.getItem("editMode") !== "false";
  editMode.onchange = () => {
    localStorage.setItem("editMode", editMode.checked);
    if(!editMode.checked) select(null);
  };

  function select(el){
    document.querySelectorAll(".selected").forEach(e=>e.classList.remove("selected"));
    selected=el;
    if(!el){
      selectedLabel.textContent="None";
      statusSelect.disabled=true;
      applyBtn.disabled=true;
      return;
    }
    el.classList.add("selected");
    selectedLabel.textContent=el.dataset.id;
    statusSelect.disabled=false;
    applyBtn.disabled=false;
  }

  clearBtn.onclick = ()=> select(null);

  applyBtn.onclick = async ()=>{
    if(!selected) return;
    const id = selected.dataset.id;
    const toStatus = statusSelect.value;

    applyBtn.disabled = true;
    cloudPill.textContent = "Cloud: saving…";

    try{
      await updateMachineStatus(id, toStatus);
      // repaint immediately
      applyStatus(selected, toStatus);
      cloudPill.textContent = "Cloud: saved ✓";
    }catch(err){
      console.error(err);
      cloudPill.textContent = "Cloud: error saving";
      alert("Error saving to cloud. Check console.");
    }finally{
      applyBtn.disabled = false;
    }
  };

  // Admin password (unchanged)
  document.getElementById("adminBtn").onclick=()=>{
    const pw=prompt("Enter admin password:");
    if(pw==="ZF135") location.href="admin.html";
    else if(pw!==null) alert("Incorrect password");
  };

  
// Layout Builder (password-gated; client-side)
document.getElementById("layoutBtn").onclick=()=>{
  const pw=prompt("Layout Builder password:");
  if(pw==="layout82"){
    sessionStorage.setItem("layoutBuilderAuthed","1");
    location.href="layout.html";
  } else if(pw!==null){
    alert("Incorrect password");
  }
};

// Apply saved layout (if present) from Supabase
async function applySavedLayout(){
  try{
    const { data, error } = await sb
      .from("layout_elements")
      .select("element_id,x,y,bottom,w,h");
    if (error) throw error;
    if (!data || !data.length) return;

    for (const row of data){
      const elId = row.element_id;
      let el = document.querySelector(`[data-id="${elId}"]`);
      if (!el && elId === "packoutBadge"){
        el = document.getElementById("packoutBadge");
      }
      if (!el) continue;

      if (row.x != null) el.style.left = `${row.x}%`;
      if (row.y != null) el.style.top = `${row.y}%`;
      if (row.bottom != null) el.style.bottom = `${row.bottom}%`;
      if (row.w != null) el.style.width = `${row.w}%`;
      if (row.h != null) el.style.height = `${row.h}%`;
    }
  }catch(e){
    console.warn("Layout load failed (table may not exist yet):", e);
  }
}

function wireBoxClicks(){
    document.querySelectorAll('.box[data-id]').forEach(b=>{
      b.onclick = (e)=>{
        if(editMode.checked){
          e.preventDefault();
          select(b);
        }
      };
    });
  }

  async function loadBoard(){
    cloudPill.textContent = "Cloud: connecting…";
    await ensureMachinesExist();
    const map = await fetchMachines();

    document.querySelectorAll('.box[data-id]').forEach(b=>{
      const row = map.get(b.dataset.id);
      const status = (row?.status || "running").toLowerCase();
      applyStatus(b, status);
    });

    cloudPill.textContent = "Cloud: connected ✓";
  }

  async function refreshSelectedStatus(){
    if(!selected) return;
    const id = selected.dataset.id;
    const { data, error } = await sb.from("machines").select("status").eq("id", id).maybeSingle();
    if(!error){
      statusSelect.value = (data?.status || "running").toLowerCase();
    }
  }

  // Basic polling so other PCs’ changes show up (every 5 seconds)
  async function poll(){
    try{
      const map = await fetchMachines();
      document.querySelectorAll('.box[data-id]').forEach(b=>{
        const row = map.get(b.dataset.id);
        const status = (row?.status || "running").toLowerCase();
        applyStatus(b, status);
      });
      await renderPackoutBadge();
    await updatePumpWeeklyBadges();
      await refreshSelectedStatus();
    }catch(err){
      console.error(err);
      cloudPill.textContent = "Cloud: polling error";
    }
  }

async function updatePumpWeeklyBadges(){
  try{
    const now = new Date();
    const ws = getWeekStartMonday(now);
    const we = new Date(ws);
    we.setDate(we.getDate() + 7);
    const wsISO = fmtISODate(ws);
    const weISO = fmtISODate(we);

    const { data, error } = await sb
      .from("production_entries")
      .select("machine_id,prod_date,parts_ran")
      .in("machine_id", ["pump1","pump2"])
      .gte("prod_date", wsISO)
      .lt("prod_date", weISO);

    if (error) throw error;

    let p1 = 0, p2 = 0;
    (data || []).forEach(r=>{
      const v = Number(r.parts_ran || 0);
      if (r.machine_id === "pump1") p1 += v;
      if (r.machine_id === "pump2") p2 += v;
    });

    const e1 = document.getElementById("pump1WTD");
    const e2 = document.getElementById("pump2WTD");
    if (e1) e1.textContent = p1.toLocaleString();
    if (e2) e2.textContent = p2.toLocaleString();
  }catch(err){
    console.warn("Pump weekly badge update failed:", err);
  }
}

async function init(){
    try{
      wireBoxClicks();
            await applySavedLayout();
await loadBoard();
      await renderPackoutBadge();
      // initial select state
      statusSelect.disabled = true;
      applyBtn.disabled = true;

      // poll updates
      setInterval(poll, 5000);
    }catch(err){
      console.error(err);
      cloudPill.textContent = "Cloud: connection error";
      alert("Cloud connection error. Check console + Supabase keys/RLS.");
    }
  
<script>
  const SUPABASE_URL = "https://vycwkgpdivxazjgsrgiq.supabase.co";
  const SUPABASE_ANON_KEY = "sb_publishable_aAjs8tF_8c8sB30ekxSXZQ_KxaBMBTE";

  function loadSupabaseThen(run) {
    const s = document.createElement("script");
    s.src = "https://unpkg.com/@supabase/supabase-js@2";
    s.onload = run;
    s.onerror = () => {
      console.error("Failed to load Supabase JS");
      alert("Supabase library failed to load.");
    };
    document.head.appendChild(s);
  }

  loadSupabaseThen(() => {
    if (!window.supabase) {
      console.error("Supabase loaded but window.supabase undefined");
      return;
    }
    window.sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: { persistSession:false, autoRefreshToken:false, detectSessionInUrl:false }
    });
    if (typeof init === "function") init();
  });
</script>

</body>
</html>

