<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Machine</title>
  <style>
    body{ font-family: Arial, Helvetica, sans-serif; margin:0; background:#f6f6f6; }
    .wrap{ max-width:1250px; margin:24px auto; padding:0 16px; }
    .topbar{
      display:flex; flex-wrap:wrap; gap:12px; align-items:center; justify-content:space-between;
      margin-bottom:12px;
    }
    .card{
      background:#fff; border:1px solid #ddd; border-radius:12px;
      padding:16px; box-shadow:0 6px 18px rgba(0,0,0,.06);
    }
    .title{ font-size:22px; margin:0; }
    .muted{ color:#666; margin:4px 0 0; }
    a{ color:#1a73e8; text-decoration:none; }

    .grid{ display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    @media (max-width: 980px){ .grid{ grid-template-columns: 1fr; } }

    .section-title{ margin:0 0 10px; font-size:16px; font-weight:bold; }

    .form{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px 12px;
      align-items:end;
    }
    .form .full{ grid-column: 1 / -1; }

    label{ display:block; font-size:12px; color:#444; margin-bottom:6px; }
    input, select, textarea{
      width:100%;
      font-size:14px;
      padding:10px;
      border-radius:10px;
      border:1px solid #ccc;
      box-sizing:border-box;
      background:#fff;
    }
    textarea{ min-height:76px; resize:vertical; }

    .actions{ display:flex; gap:10px; flex-wrap:wrap; margin-top:12px; }
    button{
      padding:10px 12px;
      border-radius:10px;
      border:1px solid #111;
      background:#111;
      color:#fff;
      cursor:pointer;
      font-size:14px;
    }
    button.secondary{ background:#fff; color:#111; border-color:#ccc; }

    .pill{
      font-size:12px;
      border:1px solid #ddd;
      border-radius:999px;
      padding:6px 10px;
      background:#fafafa;
      color:#333;
      user-select:none;
      white-space:nowrap;
      display:inline-flex;
      align-items:center;
      gap:8px;
    }

    .summary{ display:flex; gap:10px; flex-wrap:wrap; margin:10px 0 0; }

    table{ width:100%; border-collapse:collapse; margin-top:12px; font-size:13px; }
    th, td{ border:1px solid #ddd; padding:8px; vertical-align:top; text-align:left; }
    th{ background:#fafafa; }

    .table-actions{ display:flex; gap:8px; flex-wrap:wrap; }
    .smallbtn{
      padding:6px 10px;
      border-radius:9px;
      border:1px solid #ccc;
      background:#fff;
      color:#111;
      cursor:pointer;
      font-size:12px;
    }
    .smallbtn.primary{ background:#111; color:#fff; border-color:#111; }
    .smallbtn.danger{ background:#b00020; color:#fff; border-color:#b00020; }

    .note{ color:#555; font-size:13px; margin-top:10px; }
    .timing-grid{ display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div>
        <h1 class="title" id="pageTitle">Machine</h1>
        <div class="muted" id="pageSub"></div>
      </div>

      <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
        <span class="pill" id="savePill">No entries yet</span>

        <span class="pill">
          <strong style="font-size:12px;">Status</strong>
          <select id="machineStatus" style="padding:6px 10px; border-radius:10px;">
            <option value="running">Running</option>
            <option value="problems">Problems</option>
            <option value="down">Down</option>
            <option value="no_operator">No Operator</option>
          </select>
        </span>

        <a href="index.html">← Back to layout</a>
      </div>
    </div>

    <!-- Status + Export/Import -->
    <div class="card" style="margin-bottom:12px;">
      <div class="section-title">Status</div>
      <div class="timing-grid">
        <span class="pill" id="statusTimerPill">—</span>
      </div>

      <div class="actions" style="margin-top:10px;">
        <button class="secondary" id="exportLogBtn">Export status change log (.txt)</button>
        <button class="secondary" id="exportAllBtn">Export ALL data (.json)</button>
        <button class="secondary" id="importAllBtn">Import data (.json)</button>
        <input id="importFileInput" type="file" accept="application/json" style="display:none" />
      </div>

      <div class="note" id="logPreviewNote"></div>
      <div class="note">Auto-loads <b>plant-data.json</b> when running via the BAT/localhost.</div>
    </div>

    <div class="grid">
      <!-- LEFT: Project -->
      <div class="card">
        <div class="section-title">Project</div>

        <div class="form">
          <div class="full">
            <label for="projectName">Project name</label>
            <input id="projectName" placeholder="e.g., New fixture install" />
          </div>

          <div>
            <label for="eta">ETA</label>
            <input id="eta" type="date" />
          </div>

          <div>
            <label for="cost">Cost</label>
            <input id="cost" type="number" step="0.01" placeholder="e.g., 1250.00" />
          </div>

          <div>
            <label for="dateFinished">Date finished</label>
            <input id="dateFinished" type="date" />
          </div>

          <div>
            <label for="progress">Progress</label>
            <select id="progress">
              <option value="">Select…</option>
              <option value="25">25%</option>
              <option value="50">50%</option>
              <option value="75">75%</option>
              <option value="100">100%</option>
            </select>
          </div>

          <div class="full">
            <label for="projectNotes">Notes</label>
            <textarea id="projectNotes" placeholder="Optional notes…"></textarea>
          </div>
        </div>

        <div class="actions">
          <button id="projSaveBtn">Save new project entry</button>
          <button class="secondary" id="projUpdateBtn" disabled>Update project entry</button>
          <button class="secondary" id="projCancelBtn" disabled>Cancel edit</button>
        </div>

        <div class="note">Project History (left) is separate from Production History (right).</div>
        <div id="projectHistoryHost"></div>
      </div>

      <!-- RIGHT: Production / Scrap -->
      <div class="card">
        <div class="section-title">Production / Scrap</div>

        <div class="form">
          <div>
            <label for="prodDate">Date</label>
            <input id="prodDate" type="date" />
          </div>

          <div>
            <label for="shift">Shift</label>
            <select id="shift">
              <option value="">Select…</option>
              <option value="1">1st shift</option>
              <option value="2">2nd shift</option>
              <option value="3">3rd shift</option>
            </select>
          </div>

          <div>
            <label for="partsRan"># Parts ran</label>
            <input id="partsRan" type="number" step="1" min="0" placeholder="e.g., 480" />
          </div>

          <div>
            <label for="scrapQty"># Scrap</label>
            <input id="scrapQty" type="number" step="1" min="0" placeholder="e.g., 3" />
          </div>

          <div class="full">
            <label for="scrapReason">Scrap reason</label>
            <select id="scrapReason"></select>
          </div>

          <div class="full">
            <label for="scrapNotes">Scrap notes</label>
            <textarea id="scrapNotes" placeholder="Optional: more detail…"></textarea>
          </div>
        </div>

        <div class="summary">
          <span class="pill" id="latestRate">Latest scrap rate: —</span>
          <span class="pill" id="avg5Rate">Avg (last 5): —</span>
        </div>

        <div class="actions">
          <button id="prodSaveBtn">Save new production entry</button>
          <button class="secondary" id="prodUpdateBtn" disabled>Update production entry</button>
          <button class="secondary" id="prodCancelBtn" disabled>Cancel edit</button>
        </div>

        <div class="note">Production History is used for scrap-rate calculations.</div>
        <div id="productionHistoryHost"></div>
      </div>
    </div>
  </div>

  <script>
    // ---------- machine id ----------
    const params = new URLSearchParams(location.search);
    const machineId = (params.get('id') || 'unknown').trim();

    const DISPLAY_NAMES = {
      "packout":"Packout","2699":"2699","broach1":"Broach 1","adcole":"Adcole","2958":"2958",
      "3068":"3068","3009":"3009","2985":"2985","2984":"2984","2782":"2782",
      "blohm2":"Blohm 2","blohm1":"Blohm 1","3002":"3002","gardner":"Gardner","gardner-baby":"Gardner (Baby)",
      "3015":"3015","mapro":"Mapro","cts":"CTS","2712":"2712","2965":"2965","pump1":"Pump 1","pump2":"Pump 2"
    };

    document.title = `Machine: ${DISPLAY_NAMES[machineId] || machineId}`;
    document.getElementById('pageTitle').textContent = `Machine: ${DISPLAY_NAMES[machineId] || machineId}`;
    document.getElementById('pageSub').textContent = `Machine ID: ${machineId}`;

    const savePill = document.getElementById('savePill');

    // ---------- storage keys ----------
    const STATUS_STATE_KEY = "machineStatusState";
    const STATUS_LOG_KEY   = "machineStatusLog";
    const statusSelect = document.getElementById("machineStatus");

    function nowMs(){ return Date.now(); }
    function loadJson(key, fallback){
      try { return JSON.parse(localStorage.getItem(key) || JSON.stringify(fallback)); }
      catch { return fallback; }
    }
    function saveJson(key, val){ localStorage.setItem(key, JSON.stringify(val)); }

    function ensureMachineState(id){
      const all = loadJson(STATUS_STATE_KEY, {});
      if (!all[id]){
        all[id] = { status: "running", since: nowMs() };
        saveJson(STATUS_STATE_KEY, all);
      }
      return all[id];
    }

    function appendStatusLog(id, from, to){
      const logs = loadJson(STATUS_LOG_KEY, {});
      if (!logs[id]) logs[id] = [];
      logs[id].push({ ts: new Date().toISOString(), from, to });
      saveJson(STATUS_LOG_KEY, logs);
    }

    function getMachineState(id){
      const all = loadJson(STATUS_STATE_KEY, {});
      return all[id] || ensureMachineState(id);
    }

    function setMachineStatus(id, newStatus){
      const all = loadJson(STATUS_STATE_KEY, {});
      const st = all[id] || ensureMachineState(id);

      const oldStatus = (st.status || "running").toLowerCase();
      newStatus = (newStatus || "running").toLowerCase();

      const allowed = ["running","problems","down","no_operator"];
      if (!allowed.includes(newStatus)) newStatus = "running";

      if (oldStatus !== newStatus){
        st.status = newStatus;
        st.since = nowMs();
        appendStatusLog(id, oldStatus, newStatus);
      }

      all[id] = st;
      saveJson(STATUS_STATE_KEY, all);
    }

    // init dropdown
    const st0 = ensureMachineState(machineId);
    statusSelect.value = (st0.status || "running").toLowerCase();
    statusSelect.addEventListener("change", () => {
      setMachineStatus(machineId, statusSelect.value);
      updateStatusTimerUI();
      updateLogPreview();
    });

    // ---------- single counter UI ----------
    function fmtDuration(ms){
      ms = Math.max(0, ms|0);
      const sec = Math.floor(ms / 1000);
      const days = Math.floor(sec / 86400);
      const hrs = Math.floor((sec % 86400) / 3600);
      const mins = Math.floor((sec % 3600) / 60);
      const s = sec % 60;
      if (days > 0) return `${days}d ${hrs}h ${mins}m ${s}s`;
      if (hrs > 0) return `${hrs}h ${mins}m ${s}s`;
      if (mins > 0) return `${mins}m ${s}s`;
      return `${s}s`;
    }

    function updateStatusTimerUI(){
      const st = getMachineState(machineId);
      const cur = (st.status || "running").toLowerCase();
      const since = st.since || nowMs();
      const elapsed = nowMs() - since;

      let label;
      if (cur === "running" || cur === "problems"){
        label = "Up for";
      } else if (cur === "no_operator"){
        label = "Down (No Operator) for";
      } else {
        label = "Down for";
      }

      document.getElementById("statusTimerPill").textContent = `${label}: ${fmtDuration(elapsed)}`;
    }

    setInterval(updateStatusTimerUI, 1000);
    updateStatusTimerUI();

    // ---------- export status log (.txt) ----------
    function downloadFile(filename, blob){
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    function getStatusLogLines(){
      const logsAll = loadJson(STATUS_LOG_KEY, {});
      const logs = logsAll[machineId] || [];
      if (!logs.length) return [`No status changes recorded for ${machineId}.`];

      const lines = [];
      lines.push(`Machine: ${DISPLAY_NAMES[machineId] || machineId} (${machineId})`);
      lines.push(`Generated: ${new Date().toLocaleString()}`);
      lines.push(``);
      lines.push(`Status Change Log:`);
      lines.push(`------------------`);
      logs.forEach(e => {
        const dt = new Date(e.ts);
        const ts = isNaN(dt.getTime()) ? e.ts : dt.toLocaleString();
        lines.push(`${ts}  |  ${e.from}  ->  ${e.to}`);
      });
      return lines;
    }

    document.getElementById("exportLogBtn").addEventListener("click", () => {
      const lines = getStatusLogLines();
      const safeId = machineId.replace(/[^a-z0-9_\-]/gi, "_");
      downloadFile(`${safeId}-status-log.txt`, new Blob([lines.join("\n")], {type:"text/plain"}));
    });

    function updateLogPreview(){
      const logsAll = loadJson(STATUS_LOG_KEY, {});
      const logs = logsAll[machineId] || [];
      if (!logs.length){
        document.getElementById("logPreviewNote").textContent = "No status changes yet.";
        return;
      }
      const last = logs.slice(-3).map(e => {
        const ts = new Date(e.ts).toLocaleString();
        return `${ts}: ${e.from}→${e.to}`;
      }).join(" • ");
      document.getElementById("logPreviewNote").textContent = `Latest changes: ${last}`;
    }
    updateLogPreview();

    // ---------- scrap reasons ----------
    const SCRAP_REASONS = {
      "cts": ["", "staking", "torque", "pressure"],
      "blohm1": ["", "burnt", "wide slot", "thin slot", "no teardrop"],
      "blohm2": ["", "burnt", "wide slot", "thin slot", "no teardrop"],
      "3009": ["", "out of spec"],
      "2712": ["", "flow", "spool", "operator", "veins"],
      "3015": ["", "flow", "spool", "operator", "veins"],
      "2965": ["", "flow", "spool", "operator", "veins"],
      "pump1": ["", "operator", "grease", "shaft clip", "bolts"],
      "pump2": ["", "operator", "grease", "shaft clip", "bolts"]
    };
    const DEFAULT_REASONS = ["", "operator", "out of spec", "other"];

    const scrapReasonEl = document.getElementById("scrapReason");
    function fillScrapReasons(){
      const reasons = SCRAP_REASONS[machineId] || DEFAULT_REASONS;
      scrapReasonEl.innerHTML = "";
      reasons.forEach(r => {
        const opt = document.createElement("option");
        opt.value = r;
        opt.textContent = r === "" ? "Select…" : r;
        scrapReasonEl.appendChild(opt);
      });
    }
    fillScrapReasons();

    // ---------- split histories ----------
    const PROJ_KEY = `machineProjectHistory:${machineId}`;
    const PROD_KEY = `machineProductionHistory:${machineId}`;

    const projFields = {
      projectName: document.getElementById('projectName'),
      eta: document.getElementById('eta'),
      cost: document.getElementById('cost'),
      dateFinished: document.getElementById('dateFinished'),
      progress: document.getElementById('progress'),
      projectNotes: document.getElementById('projectNotes'),
    };

    const prodFields = {
      prodDate: document.getElementById('prodDate'),
      shift: document.getElementById('shift'),
      partsRan: document.getElementById('partsRan'),
      scrapQty: document.getElementById('scrapQty'),
      scrapReason: document.getElementById('scrapReason'),
      scrapNotes: document.getElementById('scrapNotes'),
    };

    function escapeHtml(s){
      return String(s ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }
    function toNum(x){
      const n = Number(String(x ?? "").trim());
      return Number.isFinite(n) ? n : 0;
    }
    function scrapRate(partsRan, scrapQty){
      const p = toNum(partsRan);
      const s = toNum(scrapQty);
      if (p <= 0) return null;
      return (s / p) * 100;
    }
    function fmtPct(x){ return x === null ? "—" : `${x.toFixed(2)}%`; }

    function loadList(key){
      try{
        const raw = localStorage.getItem(key);
        const arr = JSON.parse(raw || "[]");
        return Array.isArray(arr) ? arr : [];
      }catch{ return []; }
    }
    function saveList(key, list){ localStorage.setItem(key, JSON.stringify(list)); }
    function newId(){
      return (crypto.randomUUID ? crypto.randomUUID() : String(Date.now()) + Math.random().toString(16).slice(2));
    }

    function setProjForm(d){
      projFields.projectName.value = d.projectName ?? "";
      projFields.eta.value = d.eta ?? "";
      projFields.cost.value = d.cost ?? "";
      projFields.dateFinished.value = d.dateFinished ?? "";
      projFields.progress.value = d.progress ?? "";
      projFields.projectNotes.value = d.projectNotes ?? "";
    }
    function getProjForm(){
      return {
        projectName: projFields.projectName.value.trim(),
        eta: projFields.eta.value,
        cost: projFields.cost.value,
        dateFinished: projFields.dateFinished.value,
        progress: projFields.progress.value,
        projectNotes: projFields.projectNotes.value.trim(),
      };
    }
    function clearProjForm(){ setProjForm({}); }

    function setProdForm(d){
      prodFields.prodDate.value = d.prodDate ?? "";
      prodFields.shift.value = d.shift ?? "";
      prodFields.partsRan.value = d.partsRan ?? "";
      prodFields.scrapQty.value = d.scrapQty ?? "";
      fillScrapReasons();
      prodFields.scrapReason.value = d.scrapReason ?? "";
      prodFields.scrapNotes.value = d.scrapNotes ?? "";
    }
    function getProdForm(){
      return {
        prodDate: prodFields.prodDate.value,
        shift: prodFields.shift.value,
        partsRan: prodFields.partsRan.value,
        scrapQty: prodFields.scrapQty.value,
        scrapReason: prodFields.scrapReason.value,
        scrapNotes: prodFields.scrapNotes.value.trim(),
      };
    }
    function clearProdForm(){ setProdForm({}); }

    let editingProjId = null;
    let editingProdId = null;

    function setProjEditMode(id){
      editingProjId = id;
      document.getElementById('projUpdateBtn').disabled = (editingProjId === null);
      document.getElementById('projCancelBtn').disabled = (editingProjId === null);
    }
    function setProdEditMode(id){
      editingProdId = id;
      document.getElementById('prodUpdateBtn').disabled = (editingProdId === null);
      document.getElementById('prodCancelBtn').disabled = (editingProdId === null);
    }

    function renderProjectHistory(list){
      const host = document.getElementById("projectHistoryHost");
      if (!list.length){ host.innerHTML = `<p class="note">No project history yet.</p>`; return; }

      const sorted = [...list].sort((a,b) => (b.createdAt || "").localeCompare(a.createdAt || ""));
      const table = document.createElement("table");
      table.innerHTML = `
        <thead>
          <tr>
            <th>Saved</th><th>Project</th><th>ETA</th><th>Cost</th>
            <th>Finished</th><th>Progress</th><th>Notes</th><th>Actions</th>
          </tr>
        </thead>
      `;
      const tbody = document.createElement("tbody");

      sorted.forEach(entry => {
        const tr = document.createElement("tr");
        const saved = entry.createdAt ? new Date(entry.createdAt).toLocaleString() : "";
        tr.innerHTML = `
          <td>${escapeHtml(saved)}</td>
          <td>${escapeHtml(entry.projectName || "")}</td>
          <td>${escapeHtml(entry.eta || "")}</td>
          <td>${escapeHtml(entry.cost ?? "")}</td>
          <td>${escapeHtml(entry.dateFinished || "")}</td>
          <td>${escapeHtml(entry.progress ? entry.progress + "%" : "")}</td>
          <td>${escapeHtml(entry.projectNotes || "")}</td>
          <td></td>
        `;
        const actionsTd = tr.children[7];
        const actions = document.createElement("div");
        actions.className = "table-actions";

        const editBtn = document.createElement("button");
        editBtn.className = "smallbtn primary";
        editBtn.textContent = "Edit";
        editBtn.addEventListener("click", () => {
          setProjForm(entry);
          setProjEditMode(entry.id);
          window.scrollTo({ top: 0, behavior: "smooth" });
        });

        const delBtn = document.createElement("button");
        delBtn.className = "smallbtn danger";
        delBtn.textContent = "Delete";
        delBtn.addEventListener("click", () => {
          if (!confirm("Delete this project entry?")) return;
          const now = loadList(PROJ_KEY).filter(e => e.id !== entry.id);
          saveList(PROJ_KEY, now);
          if (editingProjId === entry.id) { setProjEditMode(null); clearProjForm(); }
          renderAll();
        });

        actions.appendChild(editBtn);
        actions.appendChild(delBtn);
        actionsTd.appendChild(actions);
        tbody.appendChild(tr);
      });

      table.appendChild(tbody);
      host.innerHTML = "";
      host.appendChild(table);
    }

    function renderProductionHistory(list){
      const host = document.getElementById("productionHistoryHost");
      if (!list.length){ host.innerHTML = `<p class="note">No production history yet.</p>`; return; }

      const sorted = [...list].sort((a,b) => (b.createdAt || "").localeCompare(a.createdAt || ""));
      const table = document.createElement("table");
      table.innerHTML = `
        <thead>
          <tr>
            <th>Saved</th><th>Date</th><th>Shift</th><th>Parts</th><th>Scrap</th>
            <th>Reason</th><th>Scrap Rate</th><th>Notes</th><th>Actions</th>
          </tr>
        </thead>
      `;
      const tbody = document.createElement("tbody");

      sorted.forEach(entry => {
        const tr = document.createElement("tr");
        const saved = entry.createdAt ? new Date(entry.createdAt).toLocaleString() : "";
        const rate = scrapRate(entry.partsRan, entry.scrapQty);
        const shiftText = entry.shift ? (entry.shift === "1" ? "1st" : entry.shift === "2" ? "2nd" : "3rd") : "";

        tr.innerHTML = `
          <td>${escapeHtml(saved)}</td>
          <td>${escapeHtml(entry.prodDate || "")}</td>
          <td>${escapeHtml(shiftText)}</td>
          <td>${escapeHtml(entry.partsRan ?? "")}</td>
          <td>${escapeHtml(entry.scrapQty ?? "")}</td>
          <td>${escapeHtml(entry.scrapReason || "")}</td>
          <td>${escapeHtml(fmtPct(rate))}</td>
          <td>${escapeHtml(entry.scrapNotes || "")}</td>
          <td></td>
        `;

        const actionsTd = tr.children[8];
        const actions = document.createElement("div");
        actions.className = "table-actions";

        const editBtn = document.createElement("button");
        editBtn.className = "smallbtn primary";
        editBtn.textContent = "Edit";
        editBtn.addEventListener("click", () => {
          setProdForm(entry);
          setProdEditMode(entry.id);
          window.scrollTo({ top: 0, behavior: "smooth" });
        });

        const delBtn = document.createElement("button");
        delBtn.className = "smallbtn danger";
        delBtn.textContent = "Delete";
        delBtn.addEventListener("click", () => {
          if (!confirm("Delete this production entry?")) return;
          const now = loadList(PROD_KEY).filter(e => e.id !== entry.id);
          saveList(PROD_KEY, now);
          if (editingProdId === entry.id) { setProdEditMode(null); clearProdForm(); }
          renderAll();
        });

        actions.appendChild(editBtn);
        actions.appendChild(delBtn);
        actionsTd.appendChild(actions);
        tbody.appendChild(tr);
      });

      table.appendChild(tbody);
      host.innerHTML = "";
      host.appendChild(table);
    }

    function updateProductionSummary(prodList){
      const sorted = [...prodList].sort((a,b) => (b.createdAt || "").localeCompare(a.createdAt || ""));
      const latest = sorted[0];
      const latestR = latest ? scrapRate(latest.partsRan, latest.scrapQty) : null;

      const last5 = sorted.slice(0,5);
      const rates = last5.map(e => scrapRate(e.partsRan, e.scrapQty)).filter(v => v !== null);
      const avg5 = rates.length ? (rates.reduce((a,b)=>a+b,0) / rates.length) : null;

      document.getElementById('latestRate').textContent = `Latest scrap rate: ${fmtPct(latestR)}`;
      document.getElementById('avg5Rate').textContent = `Avg (last 5): ${fmtPct(avg5)}`;
    }

    function updateSavePill(projList, prodList){
      const total = projList.length + prodList.length;
      const latestIso = [...projList, ...prodList].map(e => e.createdAt || "").sort().pop();
      if (!total){ savePill.textContent = "No entries yet"; return; }
      const when = latestIso ? new Date(latestIso).toLocaleString() : "unknown";
      savePill.textContent = `Project entries: ${projList.length} • Production entries: ${prodList.length} • Last saved: ${when}`;
    }

    function addProjectEntry(){
      const list = loadList(PROJ_KEY);
      list.push({ id: newId(), createdAt: new Date().toISOString(), ...getProjForm() });
      saveList(PROJ_KEY, list);
      clearProjForm();
      setProjEditMode(null);
      renderAll();
    }
    function updateProjectEntry(){
      if (!editingProjId) return;
      const list = loadList(PROJ_KEY);
      const idx = list.findIndex(e => e.id === editingProjId);
      if (idx === -1) return;
      list[idx] = { ...list[idx], ...getProjForm(), updatedAt: new Date().toISOString() };
      saveList(PROJ_KEY, list);
      clearProjForm();
      setProjEditMode(null);
      renderAll();
    }
    function cancelProjectEdit(){ clearProjForm(); setProjEditMode(null); }

    function addProductionEntry(){
      const list = loadList(PROD_KEY);
      list.push({ id: newId(), createdAt: new Date().toISOString(), ...getProdForm() });
      saveList(PROD_KEY, list);
      clearProdForm();
      setProdEditMode(null);
      renderAll();
    }
    function updateProductionEntry(){
      if (!editingProdId) return;
      const list = loadList(PROD_KEY);
      const idx = list.findIndex(e => e.id === editingProdId);
      if (idx === -1) return;
      list[idx] = { ...list[idx], ...getProdForm(), updatedAt: new Date().toISOString() };
      saveList(PROD_KEY, list);
      clearProdForm();
      setProdEditMode(null);
      renderAll();
    }
    function cancelProductionEdit(){ clearProdForm(); setProdEditMode(null); }

    document.getElementById("projSaveBtn").addEventListener("click", addProjectEntry);
    document.getElementById("projUpdateBtn").addEventListener("click", updateProjectEntry);
    document.getElementById("projCancelBtn").addEventListener("click", cancelProjectEdit);

    document.getElementById("prodSaveBtn").addEventListener("click", addProductionEntry);
    document.getElementById("prodUpdateBtn").addEventListener("click", updateProductionEntry);
    document.getElementById("prodCancelBtn").addEventListener("click", cancelProductionEdit);

    // ---------- OPTION A Export/Import ALL ----------
    function buildAllDataExport(){
      const out = {
        version: 1,
        exportedAt: new Date().toISOString(),
        app: "plant-layout-local",
        localStorage: {}
      };

      const keys = [];
      for (let i=0; i<localStorage.length; i++){
        const k = localStorage.key(i);
        if (!k) continue;

        const owned =
          k === STATUS_STATE_KEY ||
          k === STATUS_LOG_KEY ||
          k === "editMode" ||
          k.startsWith("machineProjectHistory:") ||
          k.startsWith("machineProductionHistory:");

        if (owned) keys.push(k);
      }

      keys.forEach(k => { out.localStorage[k] = localStorage.getItem(k); });
      return out;
    }

    function applyAllDataImport(payload){
      if (!payload || typeof payload !== "object") throw new Error("Invalid file (not an object).");
      if (!payload.localStorage || typeof payload.localStorage !== "object") throw new Error("Invalid file (missing localStorage).");

      const toRemove = [];
      for (let i=0; i<localStorage.length; i++){
        const k = localStorage.key(i);
        if (!k) continue;

        const owned =
          k === STATUS_STATE_KEY ||
          k === STATUS_LOG_KEY ||
          k === "editMode" ||
          k.startsWith("machineProjectHistory:") ||
          k.startsWith("machineProductionHistory:");

        if (owned) toRemove.push(k);
      }
      toRemove.forEach(k => localStorage.removeItem(k));

      Object.entries(payload.localStorage).forEach(([k,v]) => {
        if (typeof v === "string") localStorage.setItem(k, v);
      });
    }

    document.getElementById("exportAllBtn").addEventListener("click", () => {
      const data = buildAllDataExport();
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
      const filename = `plant-data-${new Date().toISOString().replace(/[:.]/g,"-")}.json`;
      downloadFile(filename, blob);
    });

    const importInput = document.getElementById("importFileInput");
    document.getElementById("importAllBtn").addEventListener("click", () => {
      importInput.value = "";
      importInput.click();
    });

    importInput.addEventListener("change", async () => {
      const file = importInput.files && importInput.files[0];
      if (!file) return;

      try{
        const text = await file.text();
        const payload = JSON.parse(text);
        applyAllDataImport(payload);

        const st = ensureMachineState(machineId);
        statusSelect.value = (st.status || "running").toLowerCase();
        fillScrapReasons();
        updateStatusTimerUI();
        updateLogPreview();
        renderAll();

        alert("Import complete! Layout colors and histories should now match the imported file.");
      }catch(err){
        alert("Import failed: " + (err?.message || String(err)));
      }
    });

    // ---------- AUTO-LOAD plant-data.json (localhost only) ----------
    async function autoLoadPlantData(){
      try{
        const res = await fetch(`plant-data.json?cb=${Date.now()}`, { cache:"no-store" });
        if (!res.ok) return;
        const payload = await res.json();
        applyAllDataImport(payload);

        const st = ensureMachineState(machineId);
        statusSelect.value = (st.status || "running").toLowerCase();
        fillScrapReasons();
        updateStatusTimerUI();
        updateLogPreview();
        renderAll();
      }catch{
        // ignore
      }
    }

    function renderAll(){
      const projList = loadList(PROJ_KEY);
      const prodList = loadList(PROD_KEY);
      updateSavePill(projList, prodList);
      renderProjectHistory(projList);
      renderProductionHistory(prodList);
      updateProductionSummary(prodList);
    }

    (async () => {
      await autoLoadPlantData();
      renderAll();
    })();
  </script>
</body>
</html>
