<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Machine View</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    body{
      font-family: Arial, Helvetica, sans-serif;
      margin:0;
      padding:16px;
      background:#f5f5f5;
    }
    .card{
      background:#fff;
      border:1px solid #ddd;
      border-radius:14px;
      padding:14px;
      margin-bottom:16px;
      box-shadow:0 2px 10px rgba(0,0,0,.06);
    }
    .section-title{
      font-weight:700;
      margin-bottom:6px;
    }
    .note{
      font-size:12px;
      color:#555;
      line-height:1.4;
    }
    .actions{
      margin-top:10px;
    }
    button{
      padding:8px 12px;
      border-radius:10px;
      border:1px solid #444;
      background:#fff;
      cursor:pointer;
    }
    button.primary{
      background:#0ea5e9;
      color:#fff;
      border-color:#0ea5e9;
    }
    .pill{
      padding:6px 10px;
      border-radius:999px;
      background:#eee;
      font-size:12px;
      margin-right:6px;
      margin-top:6px;
      display:inline-block;
    }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body>

<h2 id="machineTitle">Machine</h2>

<!-- ================= PACKOUT WEEKLY GOALS ================= -->
<div id="packoutThroughputCard" style="display:none; margin-top:12px;">
  <div class="section-title">Packout Weekly Goals (Calendar)</div>

  <div class="note" style="margin-top:6px;">
    Enter a goal for each Monday-start week (ex: 1/19, 1/26, 2/2).
    Monthly goal = sum of all weeks in the current month up to (and including) the current week.
    Yearly goal = sum of all weeks in the year up to (and including) the current week.
  </div>

  <div class="form" style="margin-top:10px;">
    <div class="full">
      <label>Weekly goals (this year)</label>
      <div id="weeklyGoalsGrid"
           style="display:grid; grid-template-columns: repeat(4, minmax(0,1fr));
                  gap:10px; max-height:260px; overflow:auto; padding:10px;
                  border:1px solid #ddd; border-radius:12px; background:#fff;">
      </div>
      <div class="note" style="margin-top:8px;">
        Tip: edit any week, then click <strong>Save Weekly Goals</strong>.
      </div>
    </div>
  </div>

  <div class="actions">
    <button id="saveWeeklyGoalsBtn">Save Weekly Goals</button>
  </div>

  <div class="summary" style="flex-wrap:wrap;">
    <span class="pill" id="weeklyPill">Weekly: —</span>
    <span class="pill" id="monthlyPill">Monthly: —</span>
    <span class="pill" id="yearlyPill">Yearly: —</span>
    <span class="pill" id="yearlyPctPill">Year %: —</span>
  </div>

  <div class="note">
    Actuals are computed from Packout’s Production/Scrap “# Parts ran” entries.
  </div>
</div>

  // ---- Weekly Goals Helpers (Monday-start weeks) ----
function weekStartMonday(d = new Date()){
  const dt = new Date(d.getFullYear(), d.getMonth(), d.getDate());
  const day = dt.getDay(); // 0 Sun .. 6 Sat
  const diff = (day === 0) ? -6 : (1 - day); // to Monday
  dt.setDate(dt.getDate() + diff);
  dt.setHours(0,0,0,0);
  return dt;
}
function addDays(d, n){
  const dt = new Date(d);
  dt.setDate(dt.getDate() + n);
  return dt;
}
function isoDate(d){
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,"0");
  const da = String(d.getDate()).padStart(2,"0");
  return `${y}-${m}-${da}`;
}
function startOfMonth(d=new Date()){ return new Date(d.getFullYear(), d.getMonth(), 1); }
function startOfYear(d=new Date()){ return new Date(d.getFullYear(), 0, 1); }
function fmtMD(d){ return `${d.getMonth()+1}/${d.getDate()}`; }

async function fetchWeeklyGoals(year){
  const y = year ?? (new Date()).getFullYear();
  const { data, error } = await sb
    .from("weekly_goals")
    .select("week_start,goal")
    .eq("machine_id","packout")
    .gte("week_start", `${y}-01-01`)
    .lte("week_start", `${y}-12-31`);
  if (error) throw error;
  return data || [];
}
async function upsertWeeklyGoals(rows){
  const payload = rows.map(r=>({
    machine_id: "packout",
    week_start: r.week_start,
    goal: r.goal
  }));
  const { error } = await sb.from("weekly_goals")
    .upsert(payload, { onConflict: "machine_id,week_start" });
  if (error) throw error;
}

// Actuals from production_entries for Packout
async function sumPackoutParts(fromISO, toISOExclusive){
  const { data, error } = await sb
    .from("production_entries")
    .select("prod_date,parts_ran")
    .eq("machine_id","packout")
    .gte("prod_date", fromISO)
    .lt("prod_date", toISOExclusive);
  if (error) throw error;
  return (data || []).reduce((a,r)=>a + safeNum(r.parts_ran), 0);
}

function leftOrOver(goal, actual){
  const diff = (Number(goal||0) - Number(actual||0));
  if (diff >= 0) return { label:"Left", value: diff };
  return { label:"Over", value: Math.abs(diff) };
}

<script>
/* ================= SUPABASE ================= */
const SUPABASE_URL = "https://vycwkgpdivxazjgsrgiq.supabase.co";
const SUPABASE_ANON_KEY = "PASTE_YOUR_ANON_KEY_HERE";
const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* ================= HELPERS ================= */
const safeNum = v => isNaN(Number(v)) ? 0 : Number(v);

function weekStartMonday(d){
  const dt = new Date(d.getFullYear(), d.getMonth(), d.getDate());
  const day = dt.getDay();
  const diff = day === 0 ? -6 : 1 - day;
  dt.setDate(dt.getDate() + diff);
  dt.setHours(0,0,0,0);
  return dt;
}
function addDays(d,n){
  const x = new Date(d);
  x.setDate(x.getDate()+n);
  return x;
}
function iso(d){
  return d.toISOString().slice(0,10);
}
function startOfMonth(d){
  return new Date(d.getFullYear(), d.getMonth(), 1);
}
function startOfYear(d){
  return new Date(d.getFullYear(), 0, 1);
}
function leftOrOver(goal, actual){
  const diff = goal - actual;
  if(diff >= 0) return { label:"Left", value:diff };
  return { label:"Over", value:Math.abs(diff) };
}

/* ================= DATA ================= */
async function fetchWeeklyGoals(year){
  const { data, error } = await sb
    .from("weekly_goals")
    .select("week_start,goal")
    .eq("machine_id","packout")
    .gte("week_start", `${year}-01-01`)
    .lte("week_start", `${year}-12-31`);
  if(error) throw error;
  return data || [];
}

async function saveWeeklyGoals(rows){
  const payload = rows.map(r=>({
    machine_id:"packout",
    week_start:r.week_start,
    goal:r.goal
  }));
  const { error } = await sb
    .from("weekly_goals")
    .upsert(payload,{ onConflict:"machine_id,week_start" });
  if(error) throw error;
}

async function sumActual(fromISO,toISO){
  const { data, error } = await sb
    .from("production_entries")
    .select("parts_ran,prod_date")
    .eq("machine_id","packout")
    .gte("prod_date",fromISO)
    .lt("prod_date",toISO);
  if(error) throw error;
  return (data||[]).reduce((a,r)=>a+safeNum(r.parts_ran),0);
}

/* ================= RENDER ================= */
async function renderPackoutUI(){
  const card = document.getElementById("packoutThroughputCard");
  if (machineId !== "packout"){ card.style.display="none"; return; }
  card.style.display="block";

  const grid = document.getElementById("weeklyGoalsGrid");
  const weeklyPill = document.getElementById("weeklyPill");
  const monthlyPill = document.getElementById("monthlyPill");
  const yearlyPill = document.getElementById("yearlyPill");
  const yearlyPctPill = document.getElementById("yearlyPctPill");
  const saveBtn = document.getElementById("saveWeeklyGoalsBtn");

  const now = new Date();
  const y = now.getFullYear();
  const currentWeekStart = weekStartMonday(now);
  const nextWeekStart = addDays(currentWeekStart, 7);

  // Build all Monday-start weeks for the year
  const weeks = [];
  let cur = weekStartMonday(startOfYear(now));
  const stop = weekStartMonday(new Date(y+1,0,1));
  while (cur < stop){
    weeks.push(new Date(cur));
    cur = addDays(cur, 7);
  }

  const goalRows = await fetchWeeklyGoals(y);
  const goalMap = new Map(goalRows.map(r=>[r.week_start, safeNum(r.goal)]));

  // Render grid
  grid.innerHTML = "";
  for (const ws of weeks){
    const iso = isoDate(ws);
    const val = goalMap.get(iso) ?? "";
    const isCurrent = iso === isoDate(currentWeekStart);

    const wrap = document.createElement("div");
    wrap.style.border = isCurrent ? "2px solid #0ea5e9" : "1px solid #ddd";
    wrap.style.borderRadius = "12px";
    wrap.style.padding = "10px";
    wrap.style.background = "#fff";

    const title = document.createElement("div");
    title.style.fontWeight = "700";
    title.style.marginBottom = "6px";
    title.textContent = fmtMD(ws);

    const inp = document.createElement("input");
    inp.type = "number";
    inp.min = "0";
    inp.step = "1";
    inp.value = val === "" ? "" : String(val);
    inp.placeholder = "goal";
    inp.dataset.weekStart = iso;
    inp.style.width = "100%";

    wrap.appendChild(title);
    wrap.appendChild(inp);
    grid.appendChild(wrap);
  }

  // Save
  saveBtn.onclick = async ()=>{
    try{
      const inputs = Array.from(grid.querySelectorAll("input[data-week-start]"));
      const rows = inputs
        .map(i=>({ week_start: i.dataset.weekStart, goal: safeNum(i.value) }))
        .filter(r=>r.goal > 0);

      await upsertWeeklyGoals(rows);
      toast("Weekly goals saved");
      await renderPackoutUI();
    }catch(e){
      console.error(e);
      alert("Failed to save weekly goals. Check console.");
    }
  };

  // Goals
  const currentISO = isoDate(currentWeekStart);
  const weeklyGoal = safeNum(goalMap.get(currentISO));

  let monthlyGoal = 0;
  for (const ws of weeks){
    if (ws.getMonth() !== now.getMonth()) continue;
    if (ws > currentWeekStart) continue;
    monthlyGoal += safeNum(goalMap.get(isoDate(ws)));
  }

  let yearlyGoal = 0;
  for (const ws of weeks){
    if (ws > currentWeekStart) continue;
    yearlyGoal += safeNum(goalMap.get(isoDate(ws)));
  }

  // Actuals
  const weeklyActual = await sumPackoutParts(isoDate(currentWeekStart), isoDate(nextWeekStart));

  const monthActualFrom = isoDate(startOfMonth(now));
  const monthActualTo = isoDate(new Date(now.getFullYear(), now.getMonth()+1, 1));
  const monthlyActual = await sumPackoutParts(monthActualFrom, monthActualTo);

  const yearActualFrom = isoDate(startOfYear(now));
  const yearActualTo = isoDate(new Date(now.getFullYear()+1, 0, 1));
  const yearlyActual = await sumPackoutParts(yearActualFrom, yearActualTo);

  const w = leftOrOver(weeklyGoal, weeklyActual);
  const m = leftOrOver(monthlyGoal, monthlyActual);
  const yy = leftOrOver(yearlyGoal, yearlyActual);
  const pct = yearlyGoal > 0 ? Math.round((yearlyActual / yearlyGoal) * 1000)/10 : 0;

  weeklyPill.textContent = `Weekly goal ${weeklyGoal} | Actual ${weeklyActual} | ${w.label} ${w.value}`;
  monthlyPill.textContent = `Monthly goal ${monthlyGoal} | Actual ${monthlyActual} | ${m.label} ${m.value}`;
  yearlyPill.textContent = `Yearly goal ${yearlyGoal} | Actual ${yearlyActual} | ${yy.label} ${yy.value}`;
  yearlyPctPill.textContent = `Year %: ${pct}%`;
}



renderPackoutUI();
</script>

</body>
</html>

