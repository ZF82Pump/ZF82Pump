<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Machine View</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    body{
      font-family: Arial, Helvetica, sans-serif;
      margin:0;
      padding:16px;
      background:#f5f5f5;
    }
    .card{
      background:#fff;
      border:1px solid #ddd;
      border-radius:14px;
      padding:14px;
      margin-bottom:16px;
      box-shadow:0 2px 10px rgba(0,0,0,.06);
    }
    .section-title{
      font-weight:700;
      margin-bottom:6px;
    }
    .note{
      font-size:12px;
      color:#555;
      line-height:1.4;
    }
    .actions{
      margin-top:10px;
    }
    button{
      padding:8px 12px;
      border-radius:10px;
      border:1px solid #444;
      background:#fff;
      cursor:pointer;
    }
    button.primary{
      background:#0ea5e9;
      color:#fff;
      border-color:#0ea5e9;
    }
    .pill{
      padding:6px 10px;
      border-radius:999px;
      background:#eee;
      font-size:12px;
      margin-right:6px;
      margin-top:6px;
      display:inline-block;
    }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body>

<h2 id="machineTitle">Machine</h2>

<!-- ================= PACKOUT WEEKLY GOALS ================= -->
<div id="packoutThroughputCard" class="card" style="display:none;">
  <div class="section-title">Packout Weekly Goals</div>

  <div class="note">
    Enter a goal for each Monday-start week.  
    Monthly and yearly goals are calculated automatically.
  </div>

  <div id="weeklyGoalsGrid"
       style="display:grid; grid-template-columns:repeat(4,1fr); gap:10px;
              margin-top:10px; max-height:260px; overflow:auto;">
  </div>

  <div class="actions">
    <button class="primary" id="saveWeeklyGoalsBtn">Save Weekly Goals</button>
  </div>

  <div style="margin-top:10px;">
    <span class="pill" id="weeklyPill">Weekly: —</span>
    <span class="pill" id="monthlyPill">Monthly: —</span>
    <span class="pill" id="yearlyPill">Yearly: —</span>
    <span class="pill" id="yearlyPctPill">Year %: —</span>
  </div>
</div>

<script>
/* ================= SUPABASE ================= */
const SUPABASE_URL = "https://vycwkgpdivxazjgsrgiq.supabase.co";
const SUPABASE_ANON_KEY = "PASTE_YOUR_ANON_KEY_HERE";
const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* ================= HELPERS ================= */
const safeNum = v => isNaN(Number(v)) ? 0 : Number(v);

function weekStartMonday(d){
  const dt = new Date(d.getFullYear(), d.getMonth(), d.getDate());
  const day = dt.getDay();
  const diff = day === 0 ? -6 : 1 - day;
  dt.setDate(dt.getDate() + diff);
  dt.setHours(0,0,0,0);
  return dt;
}
function addDays(d,n){
  const x = new Date(d);
  x.setDate(x.getDate()+n);
  return x;
}
function iso(d){
  return d.toISOString().slice(0,10);
}
function startOfMonth(d){
  return new Date(d.getFullYear(), d.getMonth(), 1);
}
function startOfYear(d){
  return new Date(d.getFullYear(), 0, 1);
}
function leftOrOver(goal, actual){
  const diff = goal - actual;
  if(diff >= 0) return { label:"Left", value:diff };
  return { label:"Over", value:Math.abs(diff) };
}

/* ================= DATA ================= */
async function fetchWeeklyGoals(year){
  const { data, error } = await sb
    .from("weekly_goals")
    .select("week_start,goal")
    .eq("machine_id","packout")
    .gte("week_start", `${year}-01-01`)
    .lte("week_start", `${year}-12-31`);
  if(error) throw error;
  return data || [];
}

async function saveWeeklyGoals(rows){
  const payload = rows.map(r=>({
    machine_id:"packout",
    week_start:r.week_start,
    goal:r.goal
  }));
  const { error } = await sb
    .from("weekly_goals")
    .upsert(payload,{ onConflict:"machine_id,week_start" });
  if(error) throw error;
}

async function sumActual(fromISO,toISO){
  const { data, error } = await sb
    .from("production_entries")
    .select("parts_ran,prod_date")
    .eq("machine_id","packout")
    .gte("prod_date",fromISO)
    .lt("prod_date",toISO);
  if(error) throw error;
  return (data||[]).reduce((a,r)=>a+safeNum(r.parts_ran),0);
}

/* ================= RENDER ================= */
async function renderPackoutUI(){
  document.getElementById("packoutThroughputCard").style.display = "block";
  document.getElementById("machineTitle").textContent = "Packout";

  const grid = document.getElementById("weeklyGoalsGrid");
  const weeklyPill = document.getElementById("weeklyPill");
  const monthlyPill = document.getElementById("monthlyPill");
  const yearlyPill = document.getElementById("yearlyPill");
  const yearlyPctPill = document.getElementById("yearlyPctPill");

  const now = new Date();
  const year = now.getFullYear();
  const thisWeek = weekStartMonday(now);
  const nextWeek = addDays(thisWeek,7);

  const weeks = [];
  let w = weekStartMonday(startOfYear(now));
  const stop = weekStartMonday(new Date(year+1,0,1));
  while(w < stop){
    weeks.push(new Date(w));
    w = addDays(w,7);
  }

  const goals = await fetchWeeklyGoals(year);
  const goalMap = new Map(goals.map(g=>[g.week_start, safeNum(g.goal)]));

  grid.innerHTML = "";
  weeks.forEach(ws=>{
    const box = document.createElement("div");
    box.style.border = iso(ws)===iso(thisWeek) ? "2px solid #0ea5e9":"1px solid #ddd";
    box.style.borderRadius="12px";
    box.style.padding="8px";
    box.style.background="#fff";

    const t = document.createElement("div");
    t.style.fontWeight="700";
    t.textContent = `${ws.getMonth()+1}/${ws.getDate()}`;

    const inp = document.createElement("input");
    inp.type="number";
    inp.style.width="100%";
    inp.dataset.week = iso(ws);
    inp.value = goalMap.get(iso(ws)) || "";

    box.appendChild(t);
    box.appendChild(inp);
    grid.appendChild(box);
  });

  document.getElementById("saveWeeklyGoalsBtn").onclick = async ()=>{
    const rows = Array.from(grid.querySelectorAll("input"))
      .map(i=>({ week_start:i.dataset.week, goal:safeNum(i.value) }))
      .filter(r=>r.goal>0);
    await saveWeeklyGoals(rows);
    alert("Weekly goals saved");
    renderPackoutUI();
  };

  const weeklyGoal = safeNum(goalMap.get(iso(thisWeek)));

  let monthlyGoal = 0;
  let yearlyGoal = 0;
  goalMap.forEach((g,ws)=>{
    const d = new Date(ws);
    if(d <= thisWeek){
      yearlyGoal += g;
      if(d.getMonth() === now.getMonth()) monthlyGoal += g;
    }
  });

  const weeklyActual = await sumActual(iso(thisWeek), iso(nextWeek));
  const monthlyActual = await sumActual(iso(startOfMonth(now)), iso(new Date(year, now.getMonth()+1,1)));
  const yearlyActual = await sumActual(iso(startOfYear(now)), iso(new Date(year+1,0,1)));

  const wv = leftOrOver(weeklyGoal, weeklyActual);
  const mv = leftOrOver(monthlyGoal, monthlyActual);
  const yv = leftOrOver(yearlyGoal, yearlyActual);
  const pct = yearlyGoal>0 ? Math.round((yearlyActual/yearlyGoal)*1000)/10 : 0;

  weeklyPill.textContent = `Weekly ${weeklyGoal} | Actual ${weeklyActual} | ${wv.label} ${wv.value}`;
  monthlyPill.textContent = `Monthly ${monthlyGoal} | Actual ${monthlyActual} | ${mv.label} ${mv.value}`;
  yearlyPill.textContent = `Yearly ${yearlyGoal} | Actual ${yearlyActual} | ${yv.label} ${yv.value}`;
  yearlyPctPill.textContent = `Year %: ${pct}%`;
}

renderPackoutUI();
</script>

</body>
</html>
