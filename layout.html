<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Layout Builder</title>
  <style>
    body{font-family:Arial, sans-serif; margin:0; padding:0; background:#f5f5f5;}
    header{display:flex; justify-content:space-between; align-items:center; padding:12px 16px; background:#111; color:#fff;}
    header .right{display:flex; gap:10px; align-items:center;}
    button{padding:8px 10px; border:1px solid #444; background:#fff; cursor:pointer; border-radius:10px;}
    button.primary{background:#0ea5e9; border-color:#0ea5e9; color:#fff;}
    button.danger{background:#ef4444; border-color:#ef4444; color:#fff;}
    .wrap{display:grid; grid-template-columns: 340px 1fr; gap:12px; padding:12px;}
    .panel{background:#fff; border:1px solid #ddd; border-radius:14px; padding:12px; box-shadow:0 2px 10px rgba(0,0,0,.06);}
    .row{display:flex; gap:10px; align-items:center; margin:8px 0;}
    label{font-size:12px; color:#333; width:92px;}
    input,select{width:100%; padding:7px 10px; border:1px solid #ccc; border-radius:10px;}
    .muted{color:#666; font-size:12px; line-height:1.35;}
    .boardWrap{background:#fff; border:1px solid #ddd; border-radius:14px; padding:12px; box-shadow:0 2px 10px rgba(0,0,0,.06); overflow:auto;}
    .board{position:relative; width:1600px; height:780px; background:#fff; border:3px solid #000;}
    .box{position:absolute; border:1px solid #111; display:flex; align-items:center; justify-content:center; font-size:18px; user-select:none; background:#ffffff;}
    .metric-badge{position:absolute; border:1px solid #111; border-radius:12px; padding:10px; background:#fff; box-shadow:0 2px 10px rgba(0,0,0,.08); font-size:13px; display:flex; align-items:center; justify-content:center;}
    .selected{outline:3px solid #0ea5e9; outline-offset:2px;}
    .handle{position:absolute; width:12px; height:12px; right:-6px; bottom:-6px; background:#0ea5e9; border:2px solid #fff; border-radius:50%; cursor:nwse-resize;}
    .tiny{font-size:11px; opacity:.85;}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
<header>
  <div><strong>Layout Builder</strong> <span class="tiny">(drag to move, drag handle to resize)</span></div>
  <div class="right">
    <button id="backBtn">Back</button>
    <button class="primary" id="saveBtn">Save</button>
    <button class="danger" id="resetBtn">Reset</button>
  </div>
</header>

<div class="wrap">
  <div class="panel">
    <div class="muted">
      Password is checked in your browser (client-side). For real security we can switch to Supabase Auth + RLS.
    </div>
    <hr />

    <div class="row">
      <label>Element</label>
      <select id="elementSelect"></select>
    </div>

    <div class="row"><label>Left %</label><input id="leftInp" type="number" step="0.1" /></div>
    <div class="row"><label>Top %</label><input id="topInp" type="number" step="0.1" /></div>
    <div class="row"><label>Bottom %</label><input id="bottomInp" type="number" step="0.1" /></div>
    <div class="row"><label>Width %</label><input id="widthInp" type="number" step="0.1" /></div>
    <div class="row"><label>Height %</label><input id="heightInp" type="number" step="0.1" /></div>

    <div class="row"><button id="applyBtn">Apply numbers</button></div>

    <div class="muted">
      Tip: use <strong>Top</strong> for most items. For bottom-row items you can use <strong>Bottom</strong>.
      Leaving Bottom blank is fine.
    </div>

    <div class="muted" id="statusLine" style="margin-top:10px;">Cloud: connecting…</div>
  </div>

  <div class="boardWrap">
    <div class="board" id="board"></div>
  </div>
</div>

<script>
  (function(){
    const authed = sessionStorage.getItem("layoutBuilderAuthed");
    if (authed !== "1"){
      const pw = prompt("Layout Builder password:");
      if (pw === "layout82"){
        sessionStorage.setItem("layoutBuilderAuthed","1");
      } else {
        alert("Incorrect password.");
        window.location.href = "index.html";
      }
    }
  })();

  if (!window.supabase){
    alert("Supabase library failed to load.");
    throw new Error("Supabase not loaded");
  }

  const SUPABASE_URL = "https://vycwkgpdivxazjgsrgiq.supabase.co";
  const SUPABASE_ANON_KEY = "sb_publishable_aAjs8tF_8c8sB30ekxSXZQ_KxaBMBTE";
  const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const DEFAULT_ELEMENTS = [{"id": "packout", "label": "Packout", "style": "x:1%; y:4%; w:13.5%; h:30%;"}, {"id": "2699", "label": "2699", "style": "x:19.5%; y:6.5%; w:7.5%; h:8.5%;"}, {"id": "broach1", "label": "Broach 1", "style": "x:27.2%; y:6.5%; w:7.5%; h:8.5%;"}, {"id": "adcole", "label": "Adcole", "style": "x:48.5%; y:6.5%; w:7.5%; h:8.5%;"}, {"id": "2958", "label": "2958", "style": "x:78.0%; y:4.0%; w:8.8%; h:13.5%;"}, {"id": "2985", "label": "2985", "style": "x:19.5%; y:21.0%; w:7.5%; h:9.0%;"}, {"id": "2984", "label": "2984", "style": "x:27.2%; y:21.0%; w:7.5%; h:9.0%;"}, {"id": "2782", "label": "2782", "style": "x:34.9%; y:21.0%; w:7.5%; h:9.0%;"}, {"id": "3068", "label": "3068", "style": "x:69.0%; y:15.5%; w:7.5%; h:14.0%;"}, {"id": "3009", "label": "3009", "style": "x:88.0%; y:18.5%; w:7.5%; h:14.0%;"}, {"id": "blohm2", "label": "Blohm 2", "style": "x:19.5%; y:46.0%; w:7.5%; h:10.5%;"}, {"id": "blohm1", "label": "Blohm 1", "style": "x:19.5%; y:59.0%; w:7.5%; h:10.5%;"}, {"id": "3002", "label": "3002", "style": "x:30.2%; y:45.0%; w:7.5%; h:25.0%;"}, {"id": "gardner", "label": "Gardner", "style": "x:58.2%; y:44.0%; w:7.5%; h:25.0%;"}, {"id": "gardner-baby", "label": "Gardner(Baby)", "style": "x:69.8%; y:52.0%; w:7.5%; h:16.0%;"}, {"id": "3015", "label": "3015", "style": "x:19.5%; y:77.5%; w:7.5%; h:10.5%;"}, {"id": "mapro", "label": "Mapro", "style": "x:35.5%; y:77.5%; w:40.0%; h:10.5%;"}, {"id": "cts", "label": "CTS", "style": "x:76.0%; y:86.2%; w:16.0%; h:8.8%;"}, {"id": "2712", "label": "2712", "style": "x:16.0%; bottom:2.0%; w:7.5%; h:9.5%;"}, {"id": "2965", "label": "2965", "style": "x:27.5%; bottom:2.0%; w:7.5%; h:9.5%;"}, {"id": "pump1", "label": "Pump 1", "style": "x:42.0%; bottom:2.0%; w:24.0%; h:9.5%;"}, {"id": "pump2", "label": "Pump 2", "style": "x:74.5%; bottom:2.0%; w:24.0%; h:9.5%;"}, {"id": "packoutBadge", "label": "Packout Badge", "style": "x:1.0%; y:36%; w:13.5%; h:60%;"}];

  const board = document.getElementById("board");
  const elSelect = document.getElementById("elementSelect");
  const statusLine = document.getElementById("statusLine");
  const inputs = {
    left: document.getElementById("leftInp"),
    top: document.getElementById("topInp"),
    bottom: document.getElementById("bottomInp"),
    width: document.getElementById("widthInp"),
    height: document.getElementById("heightInp"),
  };

  let state = {};
  let selectedId = null;

  function parseStyleToState(styleStr){
    const get = (k) => {
      const m = styleStr.match(new RegExp(k + ':\s*([0-9.]+)%', 'i'));
      return m ? Number(m[1]) : null;
    };
    return { left:get('left'), top:get('top'), bottom:get('bottom'), width:get('width'), height:get('height') };
  }

  function applyStateToEl(el, s){
    if (s.left != null) el.style.left = s.left + '%';
    if (s.top != null) el.style.top = s.top + '%';
    if (s.bottom != null) el.style.bottom = s.bottom + '%';
    if (s.width != null) el.style.width = s.width + '%';
    if (s.height != null) el.style.height = s.height + '%';
  }

  function selectElement(id){
    selectedId = id;
    for (const node of board.querySelectorAll('.box, .metric-badge')){
      node.classList.toggle('selected', node.dataset.id === id);
    }
    elSelect.value = id;
    const s = state[id] || {};
    inputs.left.value = (s.left ?? '');
    inputs.top.value = (s.top ?? '');
    inputs.bottom.value = (s.bottom ?? '');
    inputs.width.value = (s.width ?? '');
    inputs.height.value = (s.height ?? '');
  }

  function pctFromPxX(px){ return (px / board.clientWidth) * 100; }
  function pctFromPxY(py){ return (py / board.clientHeight) * 100; }

  function makeDraggableResizable(node, id){
    const handle = document.createElement('div');
    handle.className = 'handle';
    node.appendChild(handle);

    node.addEventListener('mousedown', (e) => {
      if (e.target === handle) return;
      e.preventDefault();
      selectElement(id);

      const startX = e.clientX, startY = e.clientY;
      const start = { ...state[id] };

      const onMove = (ev) => {
        const dx = ev.clientX - startX;
        const dy = ev.clientY - startY;

        if (start.bottom != null && start.top == null){
          const elRect = node.getBoundingClientRect();
          const boardRect = board.getBoundingClientRect();
          const topPx = elRect.top - boardRect.top;
          state[id].top = pctFromPxY(topPx);
          state[id].bottom = null;
        }

        state[id].left = (start.left ?? 0) + pctFromPxX(dx);
        state[id].top = (start.top ?? 0) + pctFromPxY(dy);
        applyStateToEl(node, state[id]);
        syncInputsFromState();
      };

      const onUp = () => {
        window.removeEventListener('mousemove', onMove);
        window.removeEventListener('mouseup', onUp);
      };
      window.addEventListener('mousemove', onMove);
      window.addEventListener('mouseup', onUp);
    });

    handle.addEventListener('mousedown', (e) => {
      e.preventDefault();
      e.stopPropagation();
      selectElement(id);

      const startX = e.clientX, startY = e.clientY;
      const start = { ...state[id] };

      const onMove = (ev) => {
        const dx = ev.clientX - startX;
        const dy = ev.clientY - startY;
        state[id].width = (start.width ?? 5) + pctFromPxX(dx);
        state[id].height = (start.height ?? 5) + pctFromPxY(dy);
        applyStateToEl(node, state[id]);
        syncInputsFromState();
      };

      const onUp = () => {
        window.removeEventListener('mousemove', onMove);
        window.removeEventListener('mouseup', onUp);
      };
      window.addEventListener('mousemove', onMove);
      window.addEventListener('mouseup', onUp);
    });
  }

  function syncInputsFromState(){
    if (!selectedId) return;
    const s = state[selectedId] || {};
    inputs.left.value = (s.left ?? '');
    inputs.top.value = (s.top ?? '');
    inputs.bottom.value = (s.bottom ?? '');
    inputs.width.value = (s.width ?? '');
    inputs.height.value = (s.height ?? '');
  }

  function buildBoard(elements){
    board.innerHTML = '';
    elSelect.innerHTML = '';
    state = {};

    for (const el of elements){
      const opt = document.createElement('option');
      opt.value = el.id;
      opt.textContent = el.label || el.id;
      elSelect.appendChild(opt);

      const s = parseStyleToState(el.style || '');
      state[el.id] = s;

      const node = document.createElement('div');
      node.className = (el.id === 'packoutBadge') ? 'metric-badge' : 'box';
      node.textContent = el.label || el.id;
      node.dataset.id = el.id;

      applyStateToEl(node, s);

      node.addEventListener('click', ()=>selectElement(el.id));
      makeDraggableResizable(node, el.id);

      board.appendChild(node);
    }

    if (elements.length) selectElement(elements[0].id);
  }

  async function loadFromCloudOrDefault(){
    // Always start with defaults so you never get a blank page
    buildBoard(DEFAULT_ELEMENTS);

    try{
      const { data, error } = await sb.from("layout_elements")
        .select("element_id,x,y,bottom,w,h");
      if (error) throw error;

      const cloud = (data || []);
      if (!cloud.length){
        statusLine.textContent = "Cloud: no saved layout yet (showing defaults)";
        return;
      }

      for (const r of cloud){
        const id = r.element_id;
        if (!state[id]) continue;

        if (r.x != null) state[id].left = Number(r.x);
        if (r.y != null) state[id].top = Number(r.y);
        if (r.bottom != null) state[id].bottom = Number(r.bottom);
        if (r.w != null) state[id].width = Number(r.w);
        if (r.h != null) state[id].height = Number(r.h);

        const node = board.querySelector(`[data-id="${id}"]`);
        if (node) applyStateToEl(node, state[id]);
      }

      statusLine.textContent = "Cloud: layout loaded ✓";
      syncInputsFromState();
    } catch(e){
      console.warn(e);
      statusLine.textContent = "Cloud: load failed (showing defaults)";
    }
  }

  async function saveToCloud(){
    statusLine.textContent = "Cloud: saving…";
    try{
      const rows = Object.entries(state).map(([id, s]) => ({
        element_id: id,
        x: s.left,
        y: s.top,
        bottom: s.bottom,
        w: s.width,
        h: s.height
      }));
      const { error } = await sb.from("layout_elements").upsert(rows, { onConflict:"element_id" });
      if (error) throw error;
      statusLine.textContent = "Cloud: saved ✓";
    } catch(e){
      console.error(e);
      statusLine.textContent = "Cloud: save failed (check RLS/table)";
      alert("Save failed. Check console.");
    }
  }

  document.getElementById("applyBtn").addEventListener("click", () => {
    if (!selectedId) return;
    const s = state[selectedId];
    if (inputs.left.value !== '') s.left = Number(inputs.left.value);
    if (inputs.top.value !== '') s.top = Number(inputs.top.value);
    if (inputs.bottom.value !== '') s.bottom = Number(inputs.bottom.value);
    if (inputs.width.value !== '') s.width = Number(inputs.width.value);
    if (inputs.height.value !== '') s.height = Number(inputs.height.value);
    const node = board.querySelector(`[data-id="${selectedId}"]`);
    if (node) applyStateToEl(node, s);
  });

  elSelect.addEventListener("change", () => selectElement(elSelect.value));
  document.getElementById("saveBtn").addEventListener("click", saveToCloud);
  document.getElementById("resetBtn").addEventListener("click", () => {
    if (confirm("Reset to defaults? (Click Save to persist)")){
      buildBoard(DEFAULT_ELEMENTS);
      statusLine.textContent = "Showing defaults (not saved)";
    }
  });
  document.getElementById("backBtn").addEventListener("click", () => window.location.href = "index.html");

  loadFromCloudOrDefault();
</script>
</body>
</html>
