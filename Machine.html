<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Machine</title>
  <style>
    body{ font-family: Arial, Helvetica, sans-serif; margin:0; background:#f6f6f6; }
    .wrap{ max-width:1250px; margin:24px auto; padding:0 16px; }
    .topbar{
      display:flex; flex-wrap:wrap; gap:12px; align-items:center; justify-content:space-between;
      margin-bottom:12px;
    }
    .card{
      background:#fff; border:1px solid #ddd; border-radius:12px;
      padding:16px; box-shadow:0 6px 18px rgba(0,0,0,.06);
    }
    .title{ font-size:22px; margin:0; }
    .muted{ color:#666; margin:4px 0 0; }
    a{ color:#1a73e8; text-decoration:none; }

    .grid{ display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    @media (max-width: 980px){ .grid{ grid-template-columns: 1fr; } }

    .section-title{ margin:0 0 10px; font-size:16px; font-weight:bold; }

    .form{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px 12px;
      align-items:end;
    }
    .form .full{ grid-column: 1 / -1; }

    label{ display:block; font-size:12px; color:#444; margin-bottom:6px; }
    input, select, textarea{
      width:100%;
      font-size:14px;
      padding:10px;
      border-radius:10px;
      border:1px solid #ccc;
      box-sizing:border-box;
      background:#fff;
    }
    textarea{ min-height:76px; resize:vertical; }

    .actions{ display:flex; gap:10px; flex-wrap:wrap; margin-top:12px; }
    button{
      padding:10px 12px;
      border-radius:10px;
      border:1px solid #111;
      background:#111;
      color:#fff;
      cursor:pointer;
      font-size:14px;
    }
    button.secondary{ background:#fff; color:#111; border-color:#ccc; }

    .pill{
      font-size:12px;
      border:1px solid #ddd;
      border-radius:999px;
      padding:6px 10px;
      background:#fafafa;
      color:#333;
      user-select:none;
      white-space:nowrap;
      display:inline-flex;
      align-items:center;
      gap:8px;
    }

    .summary{ display:flex; gap:10px; flex-wrap:wrap; margin:10px 0 0; }

    table{ width:100%; border-collapse:collapse; margin-top:12px; font-size:13px; }
    th, td{ border:1px solid #ddd; padding:8px; vertical-align:top; text-align:left; }
    th{ background:#fafafa; }

    .table-actions{ display:flex; gap:8px; flex-wrap:wrap; }
    .smallbtn{
      padding:6px 10px;
      border-radius:9px;
      border:1px solid #ccc;
      background:#fff;
      color:#111;
      cursor:pointer;
      font-size:12px;
    }
    .smallbtn.primary{ background:#111; color:#fff; border-color:#111; }
    .smallbtn.danger{ background:#b00020; color:#fff; border-color:#b00020; }

    .note{ color:#555; font-size:13px; margin-top:10px; }
    .timing-grid{ display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }

    .cloudline{ margin-top:8px; color:#444; font-size:12px; }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div>
        <h1 class="title" id="pageTitle">Machine</h1>
        <div class="muted" id="pageSub"></div>
        <div class="cloudline" id="cloudLine">Cloud: connecting…</div>
      </div>

      <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
        <span class="pill" id="savePill">Loading…</span>

        <span class="pill">
          <strong style="font-size:12px;">Status</strong>
          <select id="machineStatus" style="padding:6px 10px; border-radius:10px;">
            <option value="running">Running</option>
            <option value="problems">Problems</option>
            <option value="down">Down</option>
            <option value="no_operator">No Operator</option>
          </select>
        </span>

        <a href="index.html">← Back to layout</a>
      </div>
    </div>

    <div class="card" style="margin-bottom:12px;">
      <div class="section-title">Status</div>
      <div class="timing-grid">
        <span class="pill" id="statusTimerPill">—</span>
      </div>
      <div class="note">
        Status changes are saved to the cloud (shared across PCs).
      </div>

      <div id="packoutThroughputCard" style="display:none; margin-top:12px;">
        <div class="section-title">Packout Throughput (Goal + Rollups)</div>

        <div class="form" style="margin-top:6px;">
          <div class="full">
            <label for="yearGoal">YTD Goal (Year)</label>
            <input id="yearGoal" type="number" min="0" step="1" placeholder="e.g., 250000" />
          </div>
        </div>

        <div class="actions">
          <button id="saveGoalBtn">Save Goal</button>
        </div>

        <div class="summary">
          <span class="pill" id="ytdPill">YTD: —</span>
          <span class="pill" id="mtdPill">MTD: —</span>
          <span class="pill" id="todayPill">Today: —</span>
        </div>

        <div class="note">
          Values are computed from Packout’s Production/Scrap “# Parts ran” entries in the cloud.
          MTD goal is computed automatically as (YTD goal / 12).
        </div>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT: Project -->
      <div class="card">
        <div class="section-title">Project</div>

        <div class="form">
          <div class="full">
            <label for="projectName">Project name</label>
            <input id="projectName" placeholder="e.g., New fixture install" />
          </div>

          <div>
            <label for="eta">ETA</label>
            <input id="eta" type="date" />
          </div>

          <div>
            <label for="cost">Cost</label>
            <input id="cost" type="number" step="0.01" placeholder="e.g., 1250.00" />
          </div>

          <div>
            <label for="dateFinished">Date finished</label>
            <input id="dateFinished" type="date" />
          </div>

          <div>
            <label for="progress">Progress</label>
            <select id="progress">
              <option value="">Select…</option>
              <option value="25">25%</option>
              <option value="50">50%</option>
              <option value="75">75%</option>
              <option value="100">100%</option>
            </select>
          </div>

          <div class="full">
            <label for="projectNotes">Notes</label>
            <textarea id="projectNotes" placeholder="Optional notes…"></textarea>
          </div>
        </div>

        <div class="actions">
          <button id="projSaveBtn">Save new project entry</button>
          <button class="secondary" id="projUpdateBtn" disabled>Update project entry</button>
          <button class="secondary" id="projCancelBtn" disabled>Cancel edit</button>
        </div>

        <div class="note">Project History (left) is separate from Production History (right).</div>
        <div id="projectHistoryHost"></div>
      </div>

      <!-- RIGHT: Production / Scrap -->
      <div class="card">
        <div class="section-title">Production / Scrap</div>

        <div class="form">
          <div>
            <label for="prodDate">Date</label>
            <input id="prodDate" type="date" />
          </div>

          <div>
            <label for="shift">Shift</label>
            <select id="shift">
              <option value="">Select…</option>
              <option value="1">1st shift</option>
              <option value="2">2nd shift</option>
              <option value="3">3rd shift</option>
            </select>
          </div>

          <div>
            <label for="partsRan"># Parts ran</label>
            <input id="partsRan" type="number" step="1" min="0" placeholder="e.g., 480" />
          </div>

          <div>
            <label for="scrapQty"># Scrap</label>
            <input id="scrapQty" type="number" step="1" min="0" placeholder="e.g., 3" />
          </div>

          <div class="full">
            <label for="scrapReason">Scrap reason</label>
            <select id="scrapReason"></select>
          </div>

          <div class="full">
            <label for="scrapNotes">Scrap notes</label>
            <textarea id="scrapNotes" placeholder="Optional: more detail…"></textarea>
          </div>
        </div>

        <div class="summary">
          <span class="pill" id="latestRate">Latest scrap rate: —</span>
          <span class="pill" id="avg5Rate">Avg (last 5): —</span>
        </div>

        <div class="actions">
          <button id="prodSaveBtn">Save new production entry</button>
          <button class="secondary" id="prodUpdateBtn" disabled>Update production entry</button>
          <button class="secondary" id="prodCancelBtn" disabled>Cancel edit</button>
        </div>

        <div class="note">Production History is used for scrap-rate calculations.</div>
        <div id="productionHistoryHost"></div>
      </div>
    </div>
  </div>

  <!-- Supabase via CDN -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    /***********************
     *  SUPABASE CONFIG
     ***********************/
    const SUPABASE_URL = "PASTE_YOUR_SUPABASE_URL_HERE";
    const SUPABASE_ANON_KEY = "PASTE_YOUR_SUPABASE_ANON_KEY_HERE";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY); // :contentReference[oaicite:3]{index=3}

    const cloudLine = document.getElementById("cloudLine");

    // ---------- machine id ----------
    const params = new URLSearchParams(location.search);
    const machineId = (params.get('id') || 'unknown').trim();

    const DISPLAY_NAMES = {
      "packout":"Packout","2699":"2699","broach1":"Broach 1","adcole":"Adcole","2958":"2958",
      "3068":"3068","3009":"3009","2985":"2985","2984":"2984","2782":"2782",
      "blohm2":"Blohm 2","blohm1":"Blohm 1","3002":"3002","gardner":"Gardner","gardner-baby":"Gardner (Baby)",
      "3015":"3015","mapro":"Mapro","cts":"CTS","2712":"2712","2965":"2965","pump1":"Pump 1","pump2":"Pump 2"
    };

    document.title = `Machine: ${DISPLAY_NAMES[machineId] || machineId}`;
    document.getElementById('pageTitle').textContent = `Machine: ${DISPLAY_NAMES[machineId] || machineId}`;
    document.getElementById('pageSub').textContent = `Machine ID: ${machineId}`;

    const savePill = document.getElementById('savePill');

    function safeNum(x){
      const n = Number(String(x ?? "").trim());
      return Number.isFinite(n) ? n : 0;
    }

    function escapeHtml(s){
      return String(s ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function toNum(x){ return safeNum(x); }

    function isoToday(){
      const d=new Date();
      const yyyy=d.getFullYear();
      const mm=String(d.getMonth()+1).padStart(2,"0");
      const dd=String(d.getDate()).padStart(2,"0");
      return `${yyyy}-${mm}-${dd}`;
    }
    function startOfYearISO(){ return `${new Date().getFullYear()}-01-01`; }
    function startOfMonthISO(){
      const d=new Date();
      const y=d.getFullYear();
      const m=String(d.getMonth()+1).padStart(2,"0");
      return `${y}-${m}-01`;
    }

    // ---------- status + single counter ----------
    const statusSelect = document.getElementById("machineStatus");

    function fmtDuration(ms){
      ms = Math.max(0, ms|0);
      const sec = Math.floor(ms / 1000);
      const days = Math.floor(sec / 86400);
      const hrs = Math.floor((sec % 86400) / 3600);
      const mins = Math.floor((sec % 3600) / 60);
      const s = sec % 60;
      if (days > 0) return `${days}d ${hrs}h ${mins}m ${s}s`;
      if (hrs > 0) return `${hrs}h ${mins}m ${s}s`;
      if (mins > 0) return `${mins}m ${s}s`;
      return `${s}s`;
    }

    async function ensureMachineRow(){
      // insert if missing
      const { data, error } = await supabase.from("machines").select("id").eq("id", machineId).maybeSingle();
      if (error) throw error;
      if (!data){
        const ins = await supabase.from("machines").insert([{ id: machineId, status: "running", status_since: new Date().toISOString() }]);
        if (ins.error) throw ins.error;
      }
    }

    async function getMachineState(){
      const { data, error } = await supabase
        .from("machines")
        .select("status,status_since")
        .eq("id", machineId)
        .maybeSingle();
      if (error) throw error;
      return data || { status: "running", status_since: new Date().toISOString() };
    }

    async function setMachineStatus(newStatus){
      const cur = await getMachineState();
      const fromStatus = (cur.status || "running").toLowerCase();
      const nowIso = new Date().toISOString();

      const up = await supabase
        .from("machines")
        .update({ status: newStatus, status_since: nowIso })
        .eq("id", machineId);
      if (up.error) throw up.error;

      const log = await supabase
        .from("status_log")
        .insert([{ machine_id: machineId, changed_at: nowIso, from_status: fromStatus, to_status: newStatus }]);
      if (log.error) throw log.error;
    }

    async function updateStatusTimerUI(){
      const st = await getMachineState();
      const cur = (st.status || "running").toLowerCase();
      const sinceMs = Date.parse(st.status_since || new Date().toISOString());
      const elapsed = Date.now() - sinceMs;

      let label;
      if (cur === "running" || cur === "problems") label = "Up for";
      else if (cur === "no_operator") label = "Down (No Operator) for";
      else label = "Down for";

      document.getElementById("statusTimerPill").textContent = `${label}: ${fmtDuration(elapsed)}`;
      statusSelect.value = cur;
    }

    // ---------- scrap reasons ----------
    const SCRAP_REASONS = {
      "cts": ["", "staking", "torque", "pressure"],
      "blohm1": ["", "burnt", "wide slot", "thin slot", "no teardrop"],
      "blohm2": ["", "burnt", "wide slot", "thin slot", "no teardrop"],
      "3009": ["", "out of spec"],
      "2712": ["", "flow", "spool", "operator", "veins"],
      "3015": ["", "flow", "spool", "operator", "veins"],
      "2965": ["", "flow", "spool", "operator", "veins"],
      "pump1": ["", "operator", "grease", "shaft clip", "bolts"],
      "pump2": ["", "operator", "grease", "shaft clip", "bolts"]
    };
    const DEFAULT_REASONS = ["", "operator", "out of spec", "other"];

    const scrapReasonEl = document.getElementById("scrapReason");
    function fillScrapReasons(){
      const reasons = SCRAP_REASONS[machineId] || DEFAULT_REASONS;
      scrapReasonEl.innerHTML = "";
      reasons.forEach(r => {
        const opt = document.createElement("option");
        opt.value = r;
        opt.textContent = r === "" ? "Select…" : r;
        scrapReasonEl.appendChild(opt);
      });
    }
    fillScrapReasons();

    // ---------- forms ----------
    const projFields = {
      projectName: document.getElementById('projectName'),
      eta: document.getElementById('eta'),
      cost: document.getElementById('cost'),
      dateFinished: document.getElementById('dateFinished'),
      progress: document.getElementById('progress'),
      projectNotes: document.getElementById('projectNotes'),
    };

    const prodFields = {
      prodDate: document.getElementById('prodDate'),
      shift: document.getElementById('shift'),
      partsRan: document.getElementById('partsRan'),
      scrapQty: document.getElementById('scrapQty'),
      scrapReason: document.getElementById('scrapReason'),
      scrapNotes: document.getElementById('scrapNotes'),
    };

    function setProjForm(d){
      projFields.projectName.value = d.project_name ?? "";
      projFields.eta.value = d.eta ?? "";
      projFields.cost.value = d.cost ?? "";
      projFields.dateFinished.value = d.date_finished ?? "";
      projFields.progress.value = (d.progress ?? "") === null ? "" : String(d.progress ?? "");
      projFields.projectNotes.value = d.project_notes ?? "";
    }
    function clearProjForm(){ setProjForm({}); }
    function getProjForm(){
      return {
        machine_id: machineId,
        project_name: projFields.projectName.value.trim(),
        eta: projFields.eta.value || null,
        cost: projFields.cost.value ? Number(projFields.cost.value) : null,
        date_finished: projFields.dateFinished.value || null,
        progress: projFields.progress.value ? Number(projFields.progress.value) : null,
        project_notes: projFields.projectNotes.value.trim() || null
      };
    }

    function setProdForm(d){
      prodFields.prodDate.value = d.prod_date ?? "";
      prodFields.shift.value = d.shift ?? "";
      prodFields.partsRan.value = d.parts_ran ?? "";
      prodFields.scrapQty.value = d.scrap_qty ?? "";
      fillScrapReasons();
      prodFields.scrapReason.value = d.scrap_reason ?? "";
      prodFields.scrapNotes.value = d.scrap_notes ?? "";
    }
    function clearProdForm(){ setProdForm({}); }
    function getProdForm(){
      return {
        machine_id: machineId,
        prod_date: prodFields.prodDate.value || null,
        shift: prodFields.shift.value || null,
        parts_ran: safeNum(prodFields.partsRan.value),
        scrap_qty: safeNum(prodFields.scrapQty.value),
        scrap_reason: prodFields.scrapReason.value || null,
        scrap_notes: prodFields.scrapNotes.value.trim() || null
      };
    }

    // ---------- history state ----------
    let editingProjId = null;
    let editingProdId = null;

    function setProjEditMode(id){
      editingProjId = id;
      document.getElementById('projUpdateBtn').disabled = !editingProjId;
      document.getElementById('projCancelBtn').disabled = !editingProjId;
    }
    function setProdEditMode(id){
      editingProdId = id;
      document.getElementById('prodUpdateBtn').disabled = !editingProdId;
      document.getElementById('prodCancelBtn').disabled = !editingProdId;
    }

    function scrapRate(partsRan, scrapQty){
      const p = toNum(partsRan);
      const s = toNum(scrapQty);
      if (p <= 0) return null;
      return (s / p) * 100;
    }
    function fmtPct(x){ return x === null ? "—" : `${x.toFixed(2)}%`; }

    // ---------- supabase queries ----------
    async function fetchProjects(){
      const { data, error } = await supabase
        .from("project_entries")
        .select("*")
        .eq("machine_id", machineId)
        .order("created_at", { ascending: false })
        .limit(200);
      if (error) throw error;
      return data || [];
    }

    async function fetchProduction(){
      const { data, error } = await supabase
        .from("production_entries")
        .select("*")
        .eq("machine_id", machineId)
        .order("created_at", { ascending: false })
        .limit(300);
      if (error) throw error;
      return data || [];
    }

    async function addProjectEntry(){
      const ins = await supabase.from("project_entries").insert([ getProjForm() ]);
      if (ins.error) throw ins.error;
      clearProjForm();
      setProjEditMode(null);
      await renderAll();
    }

    async function updateProjectEntry(){
      if (!editingProjId) return;
      const up = await supabase.from("project_entries").update(getProjForm()).eq("id", editingProjId);
      if (up.error) throw up.error;
      clearProjForm();
      setProjEditMode(null);
      await renderAll();
    }

    async function deleteProjectEntry(id){
      const del = await supabase.from("project_entries").delete().eq("id", id);
      if (del.error) throw del.error;
      if (editingProjId === id){ clearProjForm(); setProjEditMode(null); }
      await renderAll();
    }

    async function addProductionEntry(){
      const ins = await supabase.from("production_entries").insert([ getProdForm() ]);
      if (ins.error) throw ins.error;
      clearProdForm();
      setProdEditMode(null);
      await renderAll();
      await renderPackoutUI();
    }

    async function updateProductionEntry(){
      if (!editingProdId) return;
      const up = await supabase.from("production_entries").update(getProdForm()).eq("id", editingProdId);
      if (up.error) throw up.error;
      clearProdForm();
      setProdEditMode(null);
      await renderAll();
      await renderPackoutUI();
    }

    async function deleteProductionEntry(id){
      const del = await supabase.from("production_entries").delete().eq("id", id);
      if (del.error) throw del.error;
      if (editingProdId === id){ clearProdForm(); setProdEditMode(null); }
      await renderAll();
      await renderPackoutUI();
    }

    // ---------- render tables ----------
    function renderProjectHistory(list){
      const host = document.getElementById("projectHistoryHost");
      if (!list.length){ host.innerHTML = `<p class="note">No project history yet.</p>`; return; }

      const table = document.createElement("table");
      table.innerHTML = `
        <thead>
          <tr>
            <th>Saved</th><th>Project</th><th>ETA</th><th>Cost</th>
            <th>Finished</th><th>Progress</th><th>Notes</th><th>Actions</th>
          </tr>
        </thead>
      `;
      const tbody = document.createElement("tbody");

      list.forEach(entry => {
        const tr = document.createElement("tr");
        const saved = entry.created_at ? new Date(entry.created_at).toLocaleString() : "";
        tr.innerHTML = `
          <td>${escapeHtml(saved)}</td>
          <td>${escapeHtml(entry.project_name || "")}</td>
          <td>${escapeHtml(entry.eta || "")}</td>
          <td>${escapeHtml(entry.cost ?? "")}</td>
          <td>${escapeHtml(entry.date_finished || "")}</td>
          <td>${escapeHtml(entry.progress ? entry.progress + "%" : "")}</td>
          <td>${escapeHtml(entry.project_notes || "")}</td>
          <td></td>
        `;
        const actionsTd = tr.children[7];
        const actions = document.createElement("div");
        actions.className = "table-actions";

        const editBtn = document.createElement("button");
        editBtn.className = "smallbtn primary";
        editBtn.textContent = "Edit";
        editBtn.onclick = () => {
          setProjForm(entry);
          setProjEditMode(entry.id);
          window.scrollTo({ top: 0, behavior: "smooth" });
        };

        const delBtn = document.createElement("button");
        delBtn.className = "smallbtn danger";
        delBtn.textContent = "Delete";
        delBtn.onclick = async () => {
          if (!confirm("Delete this project entry?")) return;
          await deleteProjectEntry(entry.id);
        };

        actions.append(editBtn, delBtn);
        actionsTd.appendChild(actions);
        tbody.appendChild(tr);
      });

      table.appendChild(tbody);
      host.innerHTML = "";
      host.appendChild(table);
    }

    function renderProductionHistory(list){
      const host = document.getElementById("productionHistoryHost");
      if (!list.length){ host.innerHTML = `<p class="note">No production history yet.</p>`; return; }

      const table = document.createElement("table");
      table.innerHTML = `
        <thead>
          <tr>
            <th>Saved</th><th>Date</th><th>Shift</th><th>Parts</th><th>Scrap</th>
            <th>Reason</th><th>Scrap Rate</th><th>Notes</th><th>Actions</th>
          </tr>
        </thead>
      `;
      const tbody = document.createElement("tbody");

      list.forEach(entry => {
        const tr = document.createElement("tr");
        const saved = entry.created_at ? new Date(entry.created_at).toLocaleString() : "";
        const rate = scrapRate(entry.parts_ran, entry.scrap_qty);
        const shiftText = entry.shift ? (entry.shift === "1" ? "1st" : entry.shift === "2" ? "2nd" : "3rd") : "";

        tr.innerHTML = `
          <td>${escapeHtml(saved)}</td>
          <td>${escapeHtml(entry.prod_date || "")}</td>
          <td>${escapeHtml(shiftText)}</td>
          <td>${escapeHtml(entry.parts_ran ?? "")}</td>
          <td>${escapeHtml(entry.scrap_qty ?? "")}</td>
          <td>${escapeHtml(entry.scrap_reason || "")}</td>
          <td>${escapeHtml(fmtPct(rate))}</td>
          <td>${escapeHtml(entry.scrap_notes || "")}</td>
          <td></td>
        `;

        const actionsTd = tr.children[8];
        const actions = document.createElement("div");
        actions.className = "table-actions";

        const editBtn = document.createElement("button");
        editBtn.className = "smallbtn primary";
        editBtn.textContent = "Edit";
        editBtn.onclick = () => {
          setProdForm(entry);
          setProdEditMode(entry.id);
          window.scrollTo({ top: 0, behavior: "smooth" });
        };

        const delBtn = document.createElement("button");
        delBtn.className = "smallbtn danger";
        delBtn.textContent = "Delete";
        delBtn.onclick = async () => {
          if (!confirm("Delete this production entry?")) return;
          await deleteProductionEntry(entry.id);
        };

        actions.append(editBtn, delBtn);
        actionsTd.appendChild(actions);
        tbody.appendChild(tr);
      });

      table.appendChild(tbody);
      host.innerHTML = "";
      host.appendChild(table);
    }

    function updateProductionSummary(prodList){
      const latest = prodList[0];
      const latestR = latest ? scrapRate(latest.parts_ran, latest.scrap_qty) : null;

      const last5 = prodList.slice(0,5);
      const rates = last5.map(e => scrapRate(e.parts_ran, e.scrap_qty)).filter(v => v !== null);
      const avg5 = rates.length ? (rates.reduce((a,b)=>a+b,0) / rates.length) : null;

      document.getElementById('latestRate').textContent = `Latest scrap rate: ${fmtPct(latestR)}`;
      document.getElementById('avg5Rate').textContent = `Avg (last 5): ${fmtPct(avg5)}`;
    }

    function updateSavePill(projList, prodList){
      const total = projList.length + prodList.length;
      const latestIso = [...projList, ...prodList].map(e => e.created_at || "").sort().pop();
      if (!total){ savePill.textContent = "No entries yet"; return; }
      const when = latestIso ? new Date(latestIso).toLocaleString() : "unknown";
      savePill.textContent = `Project entries: ${projList.length} • Production entries: ${prodList.length} • Last saved: ${when}`;
    }

    async function renderAll(){
      const [projList, prodList] = await Promise.all([fetchProjects(), fetchProduction()]);
      updateSavePill(projList, prodList);
      renderProjectHistory(projList);
      renderProductionHistory(prodList);
      updateProductionSummary(prodList);
    }

    // ---------- events ----------
    document.getElementById("projSaveBtn").onclick = async ()=>{ try{ await addProjectEntry(); }catch(e){ console.error(e); alert("Error saving project."); } };
    document.getElementById("projUpdateBtn").onclick = async ()=>{ try{ await updateProjectEntry(); }catch(e){ console.error(e); alert("Error updating project."); } };
    document.getElementById("projCancelBtn").onclick = ()=>{ clearProjForm(); setProjEditMode(null); };

    document.getElementById("prodSaveBtn").onclick = async ()=>{ try{ await addProductionEntry(); }catch(e){ console.error(e); alert("Error saving production."); } };
    document.getElementById("prodUpdateBtn").onclick = async ()=>{ try{ await updateProductionEntry(); }catch(e){ console.error(e); alert("Error updating production."); } };
    document.getElementById("prodCancelBtn").onclick = ()=>{ clearProdForm(); setProdEditMode(null); };

    statusSelect.onchange = async ()=>{
      const toStatus = statusSelect.value;
      cloudLine.textContent = "Cloud: saving status…";
      try{
        await setMachineStatus(toStatus);
        cloudLine.textContent = "Cloud: status saved ✓";
        await updateStatusTimerUI();
      }catch(e){
        console.error(e);
        cloudLine.textContent = "Cloud: status save error";
        alert("Error saving status.");
      }
    };

    // ---------- Packout goal + rollups ----------
    async function fetchPackoutGoal(){
      const { data, error } = await supabase.from("packout_goal").select("ytd_goal").eq("id", 1).maybeSingle();
      if (error) throw error;
      return safeNum(data?.ytd_goal);
    }
    async function setPackoutGoal(goal){
      // update single row
      const up = await supabase.from("packout_goal").update({ ytd_goal: goal }).eq("id", 1);
      if (up.error) throw up.error;
    }
    async function fetchPackoutProd(fromDateISO){
      const { data, error } = await supabase
        .from("production_entries")
        .select("prod_date,parts_ran")
        .eq("machine_id", "packout")
        .gte("prod_date", fromDateISO);
      if (error) throw error;
      return data || [];
    }
    function fmtVs(actual, goal){
      if (!goal || goal <= 0) return `${actual.toLocaleString()} / —`;
      const pct = (actual / goal) * 100;
      return `${actual.toLocaleString()} / ${goal.toLocaleString()} (${pct.toFixed(1)}%)`;
    }

    async function renderPackoutUI(){
      const card = document.getElementById("packoutThroughputCard");
      if (machineId !== "packout"){ card.style.display="none"; return; }
      card.style.display="block";

      const yearGoalEl = document.getElementById("yearGoal");
      const ytdPill = document.getElementById("ytdPill");
      const mtdPill = document.getElementById("mtdPill");
      const todayPill = document.getElementById("todayPill");

      const goalYTD = await fetchPackoutGoal();
      yearGoalEl.value = goalYTD > 0 ? String(goalYTD) : "";

      const goalMTD = goalYTD > 0 ? (goalYTD / 12) : 0;

      const ytdRows = await fetchPackoutProd(startOfYearISO());
      const mtdRows = await fetchPackoutProd(startOfMonthISO());
      const today = isoToday();

      let ytd = 0, mtd = 0, todaySum = 0;
      for (const r of ytdRows){
        const parts = safeNum(r.parts_ran);
        ytd += parts;
        if (String(r.prod_date) === today) todaySum += parts;
      }
      for (const r of mtdRows){
        mtd += safeNum(r.parts_ran);
      }

      ytdPill.textContent = `YTD: ${fmtVs(ytd, goalYTD)}`;
      mtdPill.textContent = `MTD: ${fmtVs(mtd, goalMTD)}`;
      todayPill.textContent = `Today: ${todaySum.toLocaleString()}`;

      document.getElementById("saveGoalBtn").onclick = async ()=>{
        const g = safeNum(yearGoalEl.value);
        cloudLine.textContent = "Cloud: saving Packout goal…";
        try{
          await setPackoutGoal(g);
          cloudLine.textContent = "Cloud: Packout goal saved ✓";
          await renderPackoutUI();
        }catch(e){
          console.error(e);
          cloudLine.textContent = "Cloud: Packout goal save error";
          alert("Error saving Packout goal.");
        }
      };
    }

    // ---------- init ----------
    (async function init(){
      try{
        cloudLine.textContent = "Cloud: connecting…";
        await ensureMachineRow();
        await renderAll();
        await renderPackoutUI();

        const st = await getMachineState();
        statusSelect.value = (st.status || "running").toLowerCase();

        // timer updates (reads status_since periodically)
        setInterval(async ()=>{
          try{ await updateStatusTimerUI(); }catch(e){ /* ignore */ }
        }, 1000);

        // poll histories every 10 seconds (shared updates from other PCs)
        setInterval(async ()=>{
          try{
            await renderAll();
            if(machineId==="packout") await renderPackoutUI();
          }catch(e){ /* ignore */ }
        }, 10000);

        cloudLine.textContent = "Cloud: connected ✓";
      }catch(e){
        console.error(e);
        cloudLine.textContent = "Cloud: connection error";
        alert("Cloud connection error. Check Supabase keys + RLS policies.");
      }
    })();
  </script>
</body>
</html>
